<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bravo AAC - Login/Register</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/static/mood-selection.css">
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f0f2f5;
        }
        .auth-container {
            background-color: white;
            padding: 2.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 42rem; /* Increased max-width for better layout */
            width: 100%;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #374151;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            box-sizing: border-box; /* Ensure padding doesn't increase width */
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
        }
        .button-group button {
            width: 100%;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 600;
            color: white;
            background-color: #2563eb;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .button-group button:hover {
            background-color: #1d4ed8;
        }
        .link-text {
            color: #2563eb;
            cursor: pointer;
            text-decoration: underline;
        }
        .error-message {
            color: #ef4444;
            margin-top: 0.5rem;
            text-align: center;
        }
        .loading-indicator {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Specific styles for the sections */
        .auth-section {
            display: none; /* Hidden by default */
        }
        .auth-section.active {
            display: block; /* Show active section */
        }

        /* New styles for dropdown user selection */
        .user-selection-container {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }

        .dropdown-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .user-dropdown {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            min-width: 200px;
        }

        .control-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        .edit-btn {
            background-color: #007bff;
            color: white;
        }

        .edit-btn:hover:not(:disabled) {
            background-color: #0056b3;
        }

        .delete-btn {
            background-color: #dc3545;
            color: white;
        }

        .delete-btn:hover:not(:disabled) {
            background-color: #c82333;
        }

        .copy-btn {
            background-color: #28a745;
            color: white;
        }

        .copy-btn:hover:not(:disabled) {
            background-color: #218838;
        }

        .control-btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 90%;
        }

        .modal-content h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        #cancelEditBtn {
            background-color: #6c757d;
            color: white;
        }

        #cancelCopyBtn {
            background-color: #6c757d;
            color: white;
        }

        #saveEditBtn {
            background-color: #28a745;
            color: white;
        }

        #saveCopyBtn {
            background-color: #28a745;
            color: white;
        }

        #selectUserBtn {
            background-color: #28a745;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            margin-top: 15px;
        }

        #selectUserBtn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
            opacity: 0.5;
        }

        /* Save Login Info Styles */
        .save-login-container {
            margin: 15px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f8f9fa;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 8px 0;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .checkbox-group label {
            margin: 0;
            font-weight: normal;
            cursor: pointer;
        }

        .set-default-btn {
            background-color: #28a745;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
        }

        .set-default-btn:hover {
            background-color: #218838;
        }

        .default-user-indicator {
            color: #28a745;
            font-weight: bold;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="auth-container">
        <h2 class="text-3xl font-bold text-center text-gray-800 mb-6" id="auth-title">Login</h2>

        <div id="login-section" class="auth-section active">
            <form id="login-form" class="space-y-4">
                <div class="form-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" name="email" required autocomplete="email">
                </div>
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" name="password" required autocomplete="current-password">
                </div>
                <div class="save-login-container">
                    <div class="checkbox-group">
                        <input type="checkbox" id="save-credentials" name="save-credentials">
                        <label for="save-credentials">Save login credentials (stored locally)</label>
                    </div>
                </div>
                <div class="button-group">
                    <button type="submit">Login</button>
                </div>
            </form>
            <p class="mt-4 text-center text-gray-600">
                Don't have an account? <span class="link-text" id="show-register">Register here</span>
            </p>
        </div>

        <div id="register-section" class="auth-section">
            <form id="register-form" class="space-y-4">
                <div class="form-group">
                    <label for="register-email">Email</label>
                    <input type="email" id="register-email" name="email" required autocomplete="email">
                </div>
                <div class="form-group">
                    <label for="register-password">Password (min 6 characters)</label>
                    <input type="password" id="register-password" name="password" required autocomplete="new-password">
                </div>
                <div class="form-group">
                    <label for="register-account-name">Account Name (e.g., Your Name, School Name)</label>
                    <input type="text" id="register-account-name" name="account_name" required>
                </div>
                <div class="form-group">
                    <label for="register-num-users">Number of Users (1 or more)</label>
                    <input type="number" id="register-num-users" name="num_users_allowed" value="1" min="1" required>
                </div>
                <div class="form-group">
                    <label for="register-promo-code">Promo Code (Optional)</label>
                    <input type="text" id="register-promo-code" name="promo_code">
                </div>
                <div class="form-group">
                    <label for="register-address">Address (Optional)</label>
                    <input type="text" id="register-address" name="address">
                </div>
                <div class="form-group">
                    <label for="register-phone">Phone (Optional)</label>
                    <input type="tel" id="register-phone" name="phone">
                </div>
                <div class="form-group">
                    <label for="register-therapist-email">Therapist/Admin Email (Optional)</label>
                    <input type="email" id="register-therapist-email" name="therapist_email">
                </div>
                <div class="button-group">
                    <button type="submit">Register</button>
                </div>
            </form>
            <p class="mt-4 text-center text-gray-600">
                Already have an account? <span class="link-text" id="show-login">Login here</span>
            </p>
        </div>

        <div id="profile-section" class="auth-section">
            <div id="user-selection-section" class="space-y-3">
                <!-- User selection dropdown will be injected here -->
                <p id="loading-profiles" class="text-center text-gray-500">Loading profiles...</p>
            </div>

            <div class="mt-8 pt-6 border-t border-gray-200">
                <h3 class="text-xl font-semibold text-center text-gray-700 mb-4">Add a New User Profile</h3>
                <div class="form-group">
                    <label for="newUserDisplayName" class="sr-only">New User Display Name</label>
                    <input type="text" id="newUserDisplayName" class="w-full p-3 border border-gray-300 rounded-md" placeholder="Enter new user's display name" required>
                </div>
                <button id="add-user-button" class="w-full mt-2 p-3 font-semibold text-white bg-green-600 hover:bg-green-700 rounded-md transition-colors">Add New User</button>
                <p id="add-user-status" class="text-sm text-center mt-2 h-4"></p>
            </div>

            <div class="mt-6 text-center">
                <button id="logout-button" class="text-sm text-gray-500 hover:text-red-600 hover:underline">Logout</button>
            </div>
        </div>

        <p class="error-message" id="auth-error-message"></p>
    </div>

    <div class="loading-indicator" id="loading-indicator">
        <div class="spinner"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <script>

        // Use an Immediately Invoked Function Expression (IIFE) to handle the async setup
        (async () => {
        console.log('Auth script starting - intentionalLogout flag on page load:', localStorage.getItem('bravoIntentionalLogout'));

        // --- DYNAMIC CONFIGURATION ---
        // This block replaces the hardcoded firebaseConfig object.
        let firebaseConfig;
        const loadingIndicator = document.getElementById('loading-indicator');
        const authErrorMessage = document.getElementById('auth-error-message');
        loadingIndicator.style.display = 'flex';

        try {
            // Fetch the config from our own backend. A relative URL works for any environment.
            const response = await fetch('/api/frontend-config');
            if (!response.ok) {
                throw new Error(`Could not fetch configuration from server (${response.status})`);
            }
            firebaseConfig = await response.json();
            if (!firebaseConfig.apiKey) {
                throw new Error('Invalid configuration received from server.');
            }
        } catch (error) {
            console.error('Failed to load application configuration:', error);
            authErrorMessage.textContent = 'Error: Could not load application configuration. Please refresh and try again.';
            loadingIndicator.style.display = 'none';
            return; // Stop execution if config fails to load
        }

        // Initialize Firebase with the dynamically fetched config
        firebase.initializeApp(firebaseConfig);
        console.log("Firebase dynamically initialized for project:", firebaseConfig.projectId);

        const auth = firebase.auth();

        // DOM Elements
        const loginSection = document.getElementById('login-section');
        const registerSection = document.getElementById('register-section');
        const profileSection = document.getElementById('profile-section');
        const authTitle = document.getElementById('auth-title');
        const showRegisterLink = document.getElementById('show-register');
        const showLoginLink = document.getElementById('show-login');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');

        // Function to show/hide sections
        function showSection(sectionToShow, title) {
            loginSection.classList.remove('active');
            registerSection.classList.remove('active');
            sectionToShow.classList.add('active');
            authTitle.textContent = title;
            authErrorMessage.textContent = ''; // Clear error message
            profileSection.classList.remove('active');
        }

        // Function to load saved login credentials
        function loadSavedCredentials() {
            const savedEmail = localStorage.getItem('bravoSavedEmail');
            const savedPassword = localStorage.getItem('bravoSavedPassword');
            
            const emailInput = document.getElementById('login-email');
            const passwordInput = document.getElementById('login-password');
            const saveCredentialsCheckbox = document.getElementById('save-credentials');
            
            if (savedEmail && savedPassword) {
                emailInput.value = savedEmail;
                passwordInput.value = savedPassword;
                saveCredentialsCheckbox.checked = true;
            }
        }

        // Event Listeners for switching forms
        showRegisterLink.addEventListener('click', () => showSection(registerSection, 'Register'));
        showLoginLink.addEventListener('click', () => showSection(loginSection, 'Login'));

        // Load saved credentials after page loads
        loadSavedCredentials();

        // Handle Login Form Submission
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginForm['login-email'].value;
            const password = loginForm['login-password'].value;
            const saveCredentials = document.getElementById('save-credentials').checked;
            
            authErrorMessage.textContent = ''; // Clear previous errors
            loadingIndicator.style.display = 'flex';

            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                const idToken = await user.getIdToken();
                console.log('Firebase Login successful. User UID:', user.uid);
                console.log('ID Token:', idToken);

                // Save login credentials if requested
                if (saveCredentials) {
                    localStorage.setItem('bravoSavedEmail', email);
                    localStorage.setItem('bravoSavedPassword', password);
                    localStorage.setItem('bravoAutoLogin', 'true');
                } else {
                    localStorage.removeItem('bravoSavedEmail');
                    localStorage.removeItem('bravoSavedPassword');
                    localStorage.removeItem('bravoAutoLogin');
                }

                // --- IMPORTANT: Now handle selecting the AAC user ---
                // Fetch the list of AAC users associated with this account
                const response = await fetch(`/api/account/users`, { // Use relative URL
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${idToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `Failed to fetch user profiles: ${response.status}`);
                }

                const userProfiles = await response.json();
                console.log("Fetched user profiles:", userProfiles);

                // Check if we have a default user profile and should auto-proceed
                const defaultUserId = localStorage.getItem('bravoDefaultUserId');
                
                // Auto-proceed if we have a default user
                if (defaultUserId) {
                    // Find the default user in the profiles
                    const defaultUser = userProfiles.find(profile => profile.aac_user_id === defaultUserId);
                    if (defaultUser) {
                        console.log('Auto-proceeding with default user:', defaultUser.display_name);
                        
                        // Automatically proceed to gridpage with default user
                        sessionStorage.setItem('firebaseIdToken', idToken);
                        sessionStorage.setItem('currentAacUserId', defaultUserId);
                        sessionStorage.setItem('selectedDisplayName', defaultUser.display_name);
                        window.location.href = 'gridpage.html?page=home';
                        return;
                    }
                }

                // Otherwise show the profile selection UI
                showProfileSelection(userProfiles, idToken);

            } catch (error) {
                console.error('Login error:', error);
                authErrorMessage.textContent = error.message || 'Login failed. Please check your credentials.';
            } finally {
                loadingIndicator.style.display = 'none';
            }
        });

        function showProfileSelection(userProfiles, idToken) {
            // Hide login/register forms and show the profile selection section
            loginSection.classList.remove('active');
            registerSection.classList.remove('active');
            profileSection.classList.add('active');
            authTitle.textContent = "Select Profile";

            // Store userProfiles and idToken globally for other functions
            window.currentUserProfiles = userProfiles;
            window.currentIdToken = idToken;

            displayUserProfiles(userProfiles);
            setupAddUserButton(idToken);
            setupLogoutButton();
        }

        function displayUserProfiles(profiles) {
            const userSelectionDiv = document.getElementById('user-selection-section');
            if (!profiles || profiles.length === 0) {
                userSelectionDiv.innerHTML = '<p class="text-center text-gray-500">No user profiles found. Please add one below.</p>';
                return;
            }

            // Sort profiles by display name alphabetically
            const sortedProfiles = [...profiles].sort((a, b) => 
                a.display_name.toLowerCase().localeCompare(b.display_name.toLowerCase())
            );

            // Get saved default user
            const defaultUserId = localStorage.getItem('bravoDefaultUserId');

            let html = `
                <div class="user-selection-container">
                    <label for="userDropdown">Select User Account:</label>
                    <div class="dropdown-controls">
                        <select id="userDropdown" class="user-dropdown">
            `;

            // Add profiles, with default user selected if exists, otherwise first profile
            let selectedSet = false;
            sortedProfiles.forEach((profile, index) => {
                let isSelected = '';
                if (defaultUserId && profile.aac_user_id === defaultUserId) {
                    isSelected = 'selected';
                    selectedSet = true;
                } else if (!selectedSet && index === 0) {
                    isSelected = 'selected';
                }
                
                const defaultIndicator = (defaultUserId === profile.aac_user_id) ? ' (Default)' : '';
                html += `<option value="${profile.aac_user_id}" data-display-name="${profile.display_name}" ${isSelected}>${profile.display_name}${defaultIndicator}</option>`;
            });

            html += `
                        </select>
                        <button id="editUserBtn" class="control-btn edit-btn">Edit</button>
                        <button id="deleteUserBtn" class="control-btn delete-btn">Delete</button>
                        <button id="copyUserBtn" class="control-btn copy-btn">Copy</button>
                        <button id="setDefaultBtn" class="set-default-btn">Set as Default</button>
                    </div>
                    <button id="selectUserBtn">Continue with Selected User</button>
                </div>
            `;

            userSelectionDiv.innerHTML = html;
            setupUserSelectionEventListeners();
        }

        function setupUserSelectionEventListeners() {
            const dropdown = document.getElementById('userDropdown');
            const editBtn = document.getElementById('editUserBtn');
            const deleteBtn = document.getElementById('deleteUserBtn');
            const copyBtn = document.getElementById('copyUserBtn');
            const setDefaultBtn = document.getElementById('setDefaultBtn');
            const selectBtn = document.getElementById('selectUserBtn');

            // Since first option is pre-selected, buttons start enabled
            dropdown.addEventListener('change', function() {
                const selected = this.value;
                const hasSelection = selected !== '';
                
                editBtn.disabled = !hasSelection;
                deleteBtn.disabled = !hasSelection;
                copyBtn.disabled = !hasSelection;
                setDefaultBtn.disabled = !hasSelection;
                selectBtn.disabled = !hasSelection;
            });

            editBtn.addEventListener('click', handleEditUser);
            deleteBtn.addEventListener('click', handleDeleteUser);
            copyBtn.addEventListener('click', handleCopyUser);
            setDefaultBtn.addEventListener('click', handleSetDefaultUser);
            selectBtn.addEventListener('click', handleUserSelection);
        }

        async function handleEditUser() {
            const dropdown = document.getElementById('userDropdown');
            const selectedOption = dropdown.options[dropdown.selectedIndex];
            
            if (!selectedOption || !selectedOption.value) return;

            const currentDisplayName = selectedOption.dataset.displayName;
            const userId = selectedOption.value;

            showEditUserModal(userId, currentDisplayName);
        }

        function showEditUserModal(userId, currentDisplayName) {
            const modalHTML = `
                <div id="editUserModal" class="modal-overlay">
                    <div class="modal-content">
                        <h3>Edit User Display Name</h3>
                        <form id="editUserForm">
                            <div class="form-group">
                                <label for="editDisplayName">Display Name:</label>
                                <input type="text" id="editDisplayName" value="${currentDisplayName}" required minlength="1" maxlength="50">
                            </div>
                            <div class="modal-buttons">
                                <button type="button" id="cancelEditBtn">Cancel</button>
                                <button type="submit" id="saveEditBtn">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);

            document.getElementById('cancelEditBtn').addEventListener('click', closeEditUserModal);
            document.getElementById('editUserForm').addEventListener('submit', (e) => {
                e.preventDefault();
                saveUserDisplayName(userId, currentDisplayName);
            });

            document.getElementById('editDisplayName').focus();
        }

        async function saveUserDisplayName(userId, originalName) {
            const newDisplayName = document.getElementById('editDisplayName').value.trim();
            
            if (!newDisplayName) {
                alert('Display name cannot be empty.');
                return;
            }

            if (newDisplayName === originalName) {
                closeEditUserModal();
                return;
            }

            try {
                const response = await fetch('/api/account/edit-user-display-name', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.currentIdToken}`
                    },
                    body: JSON.stringify({
                        aac_user_id: userId,
                        new_display_name: newDisplayName
                    })
                });

                if (response.ok) {
                    alert('Display name updated successfully!');
                    closeEditUserModal();
                    await loadUserProfiles();
                } else {
                    const errorData = await response.json();
                    alert(`Error updating display name: ${errorData.detail || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error updating display name:', error);
                alert('Network error occurred while updating display name.');
            }
        }

        function closeEditUserModal() {
            const modal = document.getElementById('editUserModal');
            if (modal) {
                modal.remove();
            }
        }

        async function handleCopyUser() {
            const dropdown = document.getElementById('userDropdown');
            const selectedOption = dropdown.options[dropdown.selectedIndex];
            
            if (!selectedOption || !selectedOption.value) return;

            const originalDisplayName = selectedOption.dataset.displayName;
            const originalUserId = selectedOption.value;

            showCopyUserModal(originalUserId, originalDisplayName);
        }

        function showCopyUserModal(originalUserId, originalDisplayName) {
            const modalHTML = `
                <div id="copyUserModal" class="modal-overlay">
                    <div class="modal-content">
                        <h3>Copy User Profile</h3>
                        <p>This will create a new user profile copied from "<strong>${originalDisplayName}</strong>"</p>
                        <form id="copyUserForm">
                            <div class="form-group">
                                <label for="copyDisplayName">New Display Name:</label>
                                <input type="text" id="copyDisplayName" value="${originalDisplayName} - Copy" required minlength="1" maxlength="50">
                            </div>
                            <div class="modal-buttons">
                                <button type="button" id="cancelCopyBtn">Cancel</button>
                                <button type="submit" id="saveCopyBtn">Create Copy</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);

            document.getElementById('cancelCopyBtn').addEventListener('click', closeCopyUserModal);
            document.getElementById('copyUserForm').addEventListener('submit', (e) => {
                e.preventDefault();
                copyUserProfile(originalUserId);
            });

            document.getElementById('copyDisplayName').focus();
        }

        async function copyUserProfile(originalUserId) {
            const newDisplayName = document.getElementById('copyDisplayName').value.trim();
            
            if (!newDisplayName) {
                alert('Display name cannot be empty.');
                return;
            }

            try {
                const response = await fetch('/api/account/copy-user', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.currentIdToken}`
                    },
                    body: JSON.stringify({
                        source_aac_user_id: originalUserId,
                        new_display_name: newDisplayName
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(`User profile copied successfully as "${result.new_display_name}"!`);
                    closeCopyUserModal();
                    await loadUserProfiles();
                } else {
                    const errorData = await response.json();
                    alert(`Error copying user: ${errorData.detail || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error copying user:', error);
                alert('Network error occurred while copying user.');
            }
        }

        function closeCopyUserModal() {
            const modal = document.getElementById('copyUserModal');
            if (modal) {
                modal.remove();
            }
        }

        async function handleDeleteUser() {
            const dropdown = document.getElementById('userDropdown');
            const selectedOption = dropdown.options[dropdown.selectedIndex];
            
            if (!selectedOption || !selectedOption.value) return;

            const displayName = selectedOption.dataset.displayName;
            const userId = selectedOption.value;

            if (!confirm(`Are you sure you want to delete the user "${displayName}"?\n\nThis action will permanently remove all data for this user and cannot be undone.`)) {
                return;
            }

            try {
                const response = await fetch('/api/account/delete-user', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.currentIdToken}`
                    },
                    body: JSON.stringify({
                        aac_user_id: userId
                    })
                });

                if (response.ok) {
                    // Clear default user if the deleted user was the default
                    const defaultUserId = localStorage.getItem('bravoDefaultUserId');
                    if (defaultUserId === userId) {
                        localStorage.removeItem('bravoDefaultUserId');
                        localStorage.removeItem('bravoDefaultDisplayName');
                        console.log('Cleared default user setting as deleted user was the default');
                    }
                    
                    alert('User deleted successfully!');
                    await loadUserProfiles();
                } else {
                    const errorData = await response.json();
                    alert(`Error deleting user: ${errorData.detail || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                alert('Network error occurred while deleting user.');
            }
        }

        async function handleSetDefaultUser() {
            const dropdown = document.getElementById('userDropdown');
            const selectedUserId = dropdown.value;
            
            if (!selectedUserId) {
                alert('Please select a user first.');
                return;
            }

            const selectedOption = dropdown.options[dropdown.selectedIndex];
            const displayName = selectedOption.dataset.displayName;

            // Save as default user
            localStorage.setItem('bravoDefaultUserId', selectedUserId);
            localStorage.setItem('bravoDefaultDisplayName', displayName);

            // Automatically proceed to the app with the default user
            sessionStorage.setItem('firebaseIdToken', window.currentIdToken);
            sessionStorage.setItem('currentAacUserId', selectedUserId);
            sessionStorage.setItem('selectedDisplayName', displayName);
            window.location.href = 'gridpage.html?page=home';
        }

        async function handleUserSelection() {
            const dropdown = document.getElementById('userDropdown');
            const selectedUserId = dropdown.value;
            
            if (!selectedUserId) {
                alert('Please select a user first.');
                return;
            }

            const selectedOption = dropdown.options[dropdown.selectedIndex];
            const displayName = selectedOption.dataset.displayName;

            console.log('Setting session storage with:', {
                firebaseIdToken: window.currentIdToken ? 'present' : 'missing',
                currentAacUserId: selectedUserId,
                selectedDisplayName: displayName
            });

            sessionStorage.setItem('firebaseIdToken', window.currentIdToken);
            sessionStorage.setItem('currentAacUserId', selectedUserId);
            sessionStorage.setItem('selectedDisplayName', displayName);
            
            // Verify the items were actually set
            console.log('Session storage verification:', {
                firebaseIdToken: sessionStorage.getItem('firebaseIdToken') ? 'set' : 'not set',
                currentAacUserId: sessionStorage.getItem('currentAacUserId'),
                selectedDisplayName: sessionStorage.getItem('selectedDisplayName')
            });
            
            // Small delay to ensure session storage is written
            setTimeout(() => {
                window.location.href = 'gridpage.html?page=home';
            }, 100);
        }

        async function loadUserProfiles() {
            try {
                const response = await fetch('/api/account/users', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${window.currentIdToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const userProfiles = await response.json();
                    window.currentUserProfiles = userProfiles;
                    displayUserProfiles(userProfiles);
                }
            } catch (error) {
                console.error('Error loading user profiles:', error);
            }
        }

        function setupAddUserButton(idToken) {
            const addUserButton = document.getElementById('add-user-button');
            const newUserNameInput = document.getElementById('newUserDisplayName');
            const addUserStatus = document.getElementById('add-user-status');

            async function handleAddUser() {
                const newName = newUserNameInput.value.trim();
                if (!newName) {
                    addUserStatus.textContent = 'Please enter a display name.';
                    addUserStatus.className = 'text-sm text-center mt-2 h-4 text-red-500';
                    return;
                }

                addUserStatus.textContent = 'Adding user...';
                addUserStatus.className = 'text-sm text-center mt-2 h-4 text-blue-500';
                addUserButton.disabled = true;

                try {
                    const response = await fetch('/api/account/add-aac-user', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${idToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ display_name: newName })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'Failed to add user.');
                    }

                    const newProfile = await response.json();
                    
                    newUserNameInput.value = '';
                    addUserStatus.textContent = `User "${newName}" added successfully!`;
                    addUserStatus.className = 'text-sm text-center mt-2 h-4 text-green-600';

                    await loadUserProfiles();

                } catch (error) {
                    console.error("Error adding user:", error);
                    addUserStatus.textContent = error.message;
                    addUserStatus.className = 'text-sm text-center mt-2 h-4 text-red-500';
                } finally {
                    addUserButton.disabled = false;
                }
            }

            addUserButton.addEventListener('click', handleAddUser);
        }

        function setupLogoutButton() {
            const logoutButton = document.getElementById('logout-button');
            logoutButton.addEventListener('click', () => {
                console.log('Profile page logout button clicked, forcing logout');
                // Set flag to prevent automatic re-login and auto-profile selection
                localStorage.setItem('bravoIntentionalLogout', 'true');
                localStorage.setItem('bravoSkipDefaultUser', 'true');
                console.log('Set bravoIntentionalLogout and bravoSkipDefaultUser flags for profile page logout');
                sessionStorage.clear();
                
                // Small delay to ensure localStorage is written before signing out
                setTimeout(async () => {
                    try {
                        await auth.signOut();
                        console.log('Firebase sign out completed from profile page');
                        // The onAuthStateChanged handler will show the login form
                    } catch (error) {
                        console.error('Error during Firebase sign out:', error);
                        // Force show login form even if sign out failed
                        window.location.reload();
                    }
                }, 100);
            });
        }
 
registerForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = registerForm['register-email'].value;
    const password = registerForm['register-password'].value;
    const account_name = registerForm['register-account-name'].value;
    const num_users_allowed = parseInt(registerForm['register-num-users'].value);
    const promo_code = registerForm['register-promo-code'].value || null;
    const address = registerForm['register-address'].value || null;
    const phone = registerForm['register-phone'].value || null;
    const therapist_email = registerForm['register-therapist-email'].value || null;
    let user = null; // Declare user here to make it available in the catch block

    authErrorMessage.textContent = ''; // Clear previous errors
    loadingIndicator.style.display = 'flex';

    try {
        let userCredential;

        try {
            // First, attempt to create user with Firebase Auth (client-side)
            userCredential = await auth.createUserWithEmailAndPassword(email, password);
            user = userCredential.user;
            console.log('Firebase user created during registration:', user.uid);
        } catch (firebaseError) {
            if (firebaseError.code === 'auth/email-already-in-use') {
                console.warn('Email already in use. Attempting to sign in instead...');
                // If email exists, try to sign in with the provided credentials
                try {
                    userCredential = await auth.signInWithEmailAndPassword(email, password);
                    user = userCredential.user;
                    console.log('Firebase user signed in (email already in use):', user.uid);
                    authErrorMessage.textContent = 'Account already exists. Logging you in instead.';
                } catch (signInError) {
                    // If sign-in also fails (e.g., wrong password for existing email)
                    console.error('Sign-in failed for existing email:', signInError);
                    authErrorMessage.textContent = signInError.message || 'Account already exists, but login failed. Please check password.';
                    loadingIndicator.style.display = 'none';
                    return; // Stop here if sign-in fails
                }
            } else {
                // Other Firebase authentication errors
                console.error('Firebase registration error:', firebaseError);
                authErrorMessage.textContent = firebaseError.message || 'Registration failed.';
                loadingIndicator.style.display = 'none';
                return; // Stop here for other Firebase errors
            }
        }
        
        const idToken = await user.getIdToken();
        console.log('ID Token after Firebase Auth (create/sign-in):', idToken);

        // Then, call your backend API to create/finalize the account document in Firestore
        // The backend `register_account` endpoint will now handle idempotency correctly
        // for users who already exist in Firebase Auth but not in Firestore.
        const backendResponse = await fetch(`/api/auth/register`, { // Use relative URL
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${idToken}` // Send token for backend validation
            },
            body: JSON.stringify({
                email: email, // Always send email as part of the request data
                account_name,
                num_users_allowed,
                promo_code,
                address,
                phone,
                therapist_email
            })
        });

        if (!backendResponse.ok) {
            const errorData = await backendResponse.json().catch(() => ({ detail: "Unknown error, backend did not return JSON" }));
            throw new Error(errorData.detail || `Backend registration failed: ${backendResponse.status}`);
        }

        const backendResult = await backendResponse.json();
        console.log('Backend account creation/idempotency successful:', backendResult);
        
        // Store token and initial AAC user ID
        sessionStorage.setItem('firebaseIdToken', idToken);
        sessionStorage.setItem('currentAacUserId', backendResult.first_aac_user_id);
        sessionStorage.setItem('selectedDisplayName', `${account_name}'s Device 1`); // Use provided account_name

        alert('Account setup complete! Redirecting to your grid.');
        window.location.href = `gridpage.html?page=home`;

    } catch (error) {
        console.error('Overall registration/backend error:', error);
        authErrorMessage.textContent = error.message || 'An unexpected error occurred during setup. Please try again.';
        // If Firebase user was created (variable 'user' is defined) but backend failed,
        // sign out the Firebase user to prevent an inconsistent state.
        if (user && auth.currentUser && auth.currentUser.uid === user.uid) {
            auth.signOut().then(() => {
                console.log("Signed out Firebase user due to backend registration failure.");
            }).catch(signOutError => {
                console.error("Error signing out Firebase user after backend failure:", signOutError);
            });
        }
    } finally {
        loadingIndicator.style.display = 'none';
    }
});

        // Check if user is already logged in (Firebase session persistence)
        auth.onAuthStateChanged(async (user) => {
            // Check if user intentionally logged out - if so, sign out and show login form
            const intentionalLogout = localStorage.getItem('bravoIntentionalLogout') === 'true';
            console.log('onAuthStateChanged - intentionalLogout flag:', intentionalLogout, 'user:', user ? user.uid : 'null');
            
            if (intentionalLogout) {
                console.log('User intentionally logged out, clearing flag and showing login form');
                localStorage.removeItem('bravoIntentionalLogout'); // Clear the flag
                localStorage.removeItem('bravoSkipDefaultUser'); // Also clear skip default user flag
                if (user) {
                    console.log('Signing out Firebase user due to intentional logout');
                    await auth.signOut(); // This will trigger onAuthStateChanged again with user=null
                    return; // Exit early to let the next call handle the null user case
                }
                // If user is already null, just show the login form
                loadingIndicator.style.display = 'none';
                return;
            }

            if (user) {
                console.log("Firebase user already logged in:", user.uid);
                loadingIndicator.style.display = 'flex';
                try {
                    const idToken = await user.getIdToken();
                    // Attempt to fetch user profiles to determine which AAC user to load
                    const response = await fetch(`/api/account/users`, { // Use relative URL
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${idToken}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || `Failed to fetch user profiles on re-auth: ${response.status}`);
                    }

                    const userProfiles = await response.json();
                    
                    // Check if we should skip default user auto-proceed (set when logging out from profile page)
                    const skipDefaultUser = localStorage.getItem('bravoSkipDefaultUser') === 'true';
                    if (skipDefaultUser) {
                        console.log('Skipping default user auto-proceed due to logout from profile page');
                        localStorage.removeItem('bravoSkipDefaultUser'); // Clear the flag
                        // Show profile selection instead of auto-proceeding
                        showProfileSelection(userProfiles, idToken);
                        return;
                    }
                    
                    // Check if we have a default user profile and should auto-proceed
                    const defaultUserId = localStorage.getItem('bravoDefaultUserId');
                    
                    // Auto-proceed if we have a default user
                    if (defaultUserId) {
                        // Find the default user in the profiles
                        const defaultUser = userProfiles.find(profile => profile.aac_user_id === defaultUserId);
                        if (defaultUser) {
                            console.log('Auto-proceeding with default user (existing session):', defaultUser.display_name);
                            
                            // Automatically proceed to gridpage with default user
                            sessionStorage.setItem('firebaseIdToken', idToken);
                            sessionStorage.setItem('currentAacUserId', defaultUserId);
                            sessionStorage.setItem('selectedDisplayName', defaultUser.display_name);
                            window.location.href = 'gridpage.html?page=home';
                            return;
                        }
                    }
                    
                    // Otherwise show the profile selection UI
                    showProfileSelection(userProfiles, idToken);

                } catch (error) {
                    console.error('Auto-login/profile fetch error:', error);
                    authErrorMessage.textContent = error.message || 'Failed to auto-login. Please log in manually.';
                    auth.signOut(); // Ensure user is signed out if there's an error
                } finally {
                    loadingIndicator.style.display = 'none';
                }
            } else {
                console.log("No Firebase user logged in.");
                
                // Check if user intentionally logged out - if so, don't attempt auto-login
                const intentionalLogout = localStorage.getItem('bravoIntentionalLogout') === 'true';
                if (intentionalLogout) {
                    console.log('User intentionally logged out, not attempting auto-login');
                    localStorage.removeItem('bravoIntentionalLogout'); // Clear the flag
                    loadingIndicator.style.display = 'none';
                    return;
                }
                
                // Check if we should attempt automatic login with saved credentials
                const savedEmail = localStorage.getItem('bravoSavedEmail');
                const savedPassword = localStorage.getItem('bravoSavedPassword');
                const defaultUserId = localStorage.getItem('bravoDefaultUserId');
                const autoLoginEnabled = localStorage.getItem('bravoAutoLogin') === 'true';
                
                if (savedEmail && savedPassword && defaultUserId && autoLoginEnabled) {
                    console.log('Attempting automatic login with saved credentials...');
                    loadingIndicator.style.display = 'flex';
                    
                    try {
                        const userCredential = await auth.signInWithEmailAndPassword(savedEmail, savedPassword);
                        const user = userCredential.user;
                        const idToken = await user.getIdToken();
                        console.log('Automatic login successful with saved credentials');
                        
                        // The onAuthStateChanged will trigger again and handle the auto-login flow
                        return;
                        
                    } catch (error) {
                        console.error('Automatic login failed:', error);
                        // Don't show error message here, just fall through to show login form
                    } finally {
                        loadingIndicator.style.display = 'none';
                    }
                }
                
                console.log("Displaying auth forms.");
                loadingIndicator.style.display = 'none'; // Ensure loading is hidden initially
            }
        });
    })(); // End of IIFE for async setup
    </script>
    <script src="/static/mood-selection.js"></script>
</body>
</html>