<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Button Click Activity Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="/static/admin_audit_report.js" defer></script>
    <style>
        .table-cell {
            padding: 8px;
            border: 1px solid #e2e8f0;
            text-align: left;
            font-size: 0.875rem; /* text-sm */
            word-break: break-word;
            white-space: nowrap; /* Prevent text wrapping */
        }
        .table-header {
            background-color: #f7fafc; /* bg-gray-50 */
            font-weight: 600; /* font-semibold */
        }

        /* Hamburger Menu Styles */
        .hamburger-menu {
            position: relative;
            display: inline-block;
        }
        #hamburger-btn {
            background-color: #4A5568; /* Tailwind gray-700 or similar */
            color: white;
            padding: 8px 12px; /* Adjust for a good size */
            font-size: 20px; /* Hamburger icon size */
            border: none;
            cursor: pointer;
            border-radius: 5px;
            line-height: 1; /* Ensure icon is centered vertically */
        }
        #hamburger-btn:hover {
            background-color: #2D3748; /* Darker shade for hover */
        }
        .dropdown-content {
            display: none; /* Hidden by default */
            position: absolute;
            background-color: #ffffff; /* White background for dropdown */
            min-width: 260px; /* Adjust as needed */
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1000; /* Ensure it's on top */
            left: 0; /* Align to the left of the button */
            border-radius: 5px;
            border: 1px solid #ddd; /* Light border for the dropdown */
        }
        .dropdown-content a {
            color: #333; /* Dark text for links */
            padding: 10px 15px;
            text-decoration: none;
            display: block;
            font-size: 14px; /* Standard font size for menu items */
        }
        .dropdown-content a:hover {
            background-color: #f0f0f0; /* Hover effect for links */
        }
        .dropdown-content hr {
            border: 0;
            height: 1px;
            background-color: #e0e0e0; /* Separator color */
            margin: 5px 0;
        }

    </style>
</head>
<body class="bg-gray-100">

        <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <script>
        // --- DYNAMIC AUTHENTICATION & CONFIGURATION CONTEXT ---
        (async () => {
            // 1. Fetch Firebase config dynamically
            let firebaseConfig;
            try {
                const response = await fetch('/api/frontend-config');
                if (!response.ok) throw new Error(`Server error (${response.status})`);
                const configData = await response.json();
                firebaseConfig = configData.firebase_config || configData;
                if (!firebaseConfig || !firebaseConfig.apiKey) throw new Error('Invalid config from server.');
            } catch (error) {
                console.error('Fatal: Could not load application configuration.', error);
                document.body.innerHTML = `<div style="padding: 2rem; text-align: center; color: red; font-family: sans-serif;">Failed to load application configuration. Please refresh the page.</div>`;
                return;
            }

            // 2. Initialize Firebase
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            console.log(`Firebase initialized for project: ${firebaseConfig.projectId}`);

            // 3. Check for logged-in user and set up context using onAuthStateChanged
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    const currentAacUserId = sessionStorage.getItem("currentAacUserId");
                    const tokenFromUser = await user.getIdToken();
                    sessionStorage.setItem("firebaseIdToken", tokenFromUser);

                    if (!currentAacUserId) {
                        console.warn("No AAC User ID found in session. Redirecting to auth page for user selection.");
                        window.location.href = 'auth.html';
                        return;
                    }

                    window.authenticatedFetch = async (url, options = {}) => {
                        const headers = options.headers || {};
                        headers['Authorization'] = `Bearer ${tokenFromUser}`;
                        headers['X-User-ID'] = currentAacUserId;
                        
                        // For admin access, include the target account ID
                        const adminTargetAccountId = sessionStorage.getItem('adminTargetAccountId');
                        if (adminTargetAccountId) {
                            headers['X-Admin-Target-Account'] = adminTargetAccountId;
                            console.log(`Setting admin target account header: ${adminTargetAccountId}`);
                        }
                        
                        options.headers = headers;
                        const response = await fetch(url, options);
                        if (response.status === 401 || response.status === 403) {
                            console.warn(`Auth failed (${response.status}). Redirecting to login.`);
                            sessionStorage.clear(); window.location.href = 'auth.html'; throw new Error("Session expired.");
                        }
                        return response;
                    };

                    window.currentAacUserId = currentAacUserId;
                    window.firebaseIdToken = tokenFromUser;
                    window.adminContextInitializedByInlineScript = true;
                    
                    // Global function to update page title with profile name
                    window.updatePageTitleWithProfile = async (baseTitle) => {
                        try {
                            const response = await window.authenticatedFetch('/api/account/users');
                            if (!response.ok) return;
                            
                            const profiles = await response.json();
                            const currentProfile = profiles.find(profile => profile.aac_user_id === currentAacUserId);
                            
                            if (currentProfile && currentProfile.display_name) {
                                const titleElement = document.getElementById('dynamic-page-title');
                                if (titleElement) {
                                    titleElement.textContent = `${baseTitle} - ${currentProfile.display_name}`;
                                }
                            }
                        } catch (error) {
                            console.error('Error updating page title with profile:', error);
                        }
                    };
                    
                    document.dispatchEvent(new Event('adminUserContextReady'));
                    console.log(`Admin context ready for AAC User ID: ${currentAacUserId}`);

                } else {
                    console.log("No Firebase user session found. Redirecting to auth.html.");
                    sessionStorage.clear();
                    window.location.href = 'auth.html';
                }
            });
        })();
    </script>


    <div class="page-banner flex items-center justify-between bg-[#002244] text-[#FB4F14] px-4 py-2 shadow">
        <div class="flex items-center gap-2">
            <button onclick="window.navigateToHome ? window.navigateToHome() : window.location.href='gridpage.html?page=home'" class="h-10 w-10 flex items-center justify-center text-[#FB4F14] bg-white rounded-full transition-colors duration-200 text-base hover:bg-orange-100 focus:outline-none focus:ring-2 focus:ring-orange-500" title="Home">
                <i class="fas fa-home"></i>
            </button>
            <h1 id="dynamic-page-title" class="ml-2 text-xl font-semibold">User Activity Reports</h1>
        </div>
        <div class="admin-toolbar flex items-center gap-2">
            <a href="admin_pages.html" title="Pages &amp; Buttons" class="h-10 w-10 flex items-center justify-center text-[#FB4F14] bg-white rounded-full transition-colors duration-200 text-base hover:bg-orange-100"><i class="fas fa-th-large"></i></a>
            <a href="admin_settings.html" title="Global Settings" class="h-10 w-10 flex items-center justify-center text-[#FB4F14] bg-white rounded-full transition-colors duration-200 text-base hover:bg-orange-100"><i class="fas fa-cog"></i></a>
            <a href="user_current_admin.html" title="User Current Location" class="h-10 w-10 flex items-center justify-center text-[#FB4F14] bg-white rounded-full transition-colors duration-200 text-base hover:bg-orange-100"><i class="fas fa-map-marker-alt"></i></a>
            <a href="user_info_admin.html" title="User Info &amp; Birthdays" class="h-10 w-10 flex items-center justify-center text-[#FB4F14] bg-white rounded-full transition-colors duration-200 text-base hover:bg-orange-100"><i class="fas fa-info-circle"></i></a>
            <a href="user_diary_admin.html" title="User Diary" class="h-10 w-10 flex items-center justify-center text-[#FB4F14] bg-white rounded-full transition-colors duration-200 text-base hover:bg-orange-100"><i class="fas fa-book-open"></i></a>
            <a href="audio_admin.html" title="Audio Devices" class="h-10 w-10 flex items-center justify-center text-[#FB4F14] bg-white rounded-full transition-colors duration-200 text-base hover:bg-orange-100"><i class="fas fa-volume-up"></i></a>
            <a href="favorites_admin.html" title="Event Sources" class="h-10 w-10 flex items-center justify-center text-[#FB4F14] bg-white rounded-full transition-colors duration-200 text-base hover:bg-orange-100"><i class="fas fa-star"></i></a>
            <a href="admin_audit_report.html" title="Activity Reports" class="h-10 w-10 flex items-center justify-center text-[#FB4F14] bg-white rounded-full transition-colors duration-200 text-base hover:bg-orange-100"><i class="fas fa-clipboard-list"></i></a>
            <span class="border-l border-white h-6 mx-1"></span>
            <button id="switch-user-button" title="Switch User Profile" class="h-10 w-10 flex items-center justify-center text-[#FB4F14] bg-white rounded-full transition-colors duration-200 text-base hover:bg-orange-100"><i class="fas fa-users"></i></button>
            <button id="logout-button" title="Logout" class="h-10 w-10 flex items-center justify-center text-[#FB4F14] bg-white rounded-full transition-colors duration-200 text-base hover:bg-orange-100"><i class="fas fa-sign-out-alt"></i></button>
            <button id="help-icon" title="Help" aria-label="Help" class="h-10 w-10 flex items-center justify-center text-[#FB4F14] bg-white rounded-full ml-2 transition-colors duration-200 text-base hover:bg-orange-100 focus:outline-none focus:ring-2 focus:ring-orange-500">
                <i class="fas fa-question-circle"></i>
            </button>
        </div>
    </div>


    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-6 text-center">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Button Click Activity Report</h1>
            <p class="text-sm text-gray-600">Review user button interactions within a specified date range.</p>
        </header>

        <!-- Global Page Activity Report Section -->
        <div class="bg-white p-6 rounded-lg shadow-lg mb-8">
            <h2 class="text-xl font-semibold mb-3 text-gray-700">Global Page Activity Report</h2>
            <p class="text-sm text-gray-600 mb-4">Shows page visit counts (excluding 'home'). Includes all defined pages to identify unused ones. Click counts are based on the date range selected below for the raw data.</p>
            <div class="flex space-x-2 mb-4">
                <button id="fetchGlobalActivityReportButton" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md text-sm">
                    Generate Global Page Report
                </button>
                <button id="toggleGlobalChartTypeButton" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-md text-sm">Show Pie Chart</button>
            </div>
            <div id="globalActivityReportStatus" class="mb-4 text-sm"></div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="h-96"> <!-- Added h-96 to constrain chart height -->
                    <h3 class="text-lg font-medium mb-2 text-gray-600">Page Clicks Chart</h3>
                    <canvas id="globalPageActivityChart"></canvas>
                </div>
                <div>
                    <h3 class="text-lg font-medium mb-2 text-gray-600">Page Clicks List</h3>
                    <div id="globalPageActivityListContainer" class="max-h-96 overflow-y-auto border border-gray-200 rounded-md p-3 bg-gray-50">
                        <ul id="globalPageActivityList" class="list-disc pl-5 text-sm text-gray-700"></ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page Scope Button Activity Report Section -->
        <div class="bg-white p-6 rounded-lg shadow-lg mb-8">
            <h2 class="text-xl font-semibold mb-3 text-gray-700">Page Specific Button Activity</h2>
            <p class="text-sm text-gray-600 mb-4">Select a page to see its button click counts. Includes all defined static buttons and any LLM-generated buttons clicked on that page.</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 items-end">
                <div>
                    <label for="pageSelectorDropdown" class="block text-sm font-medium text-gray-700">Select Page:</label>
                    <select id="pageSelectorDropdown" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                        <option value="">Loading pages...</option>
                    </select>
                </div>
                <button id="fetchPageButtonReportButton" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md text-sm h-10 self-end">
                    Generate Page Button Report
                </button>
            </div>
            <div id="pageButtonReportStatus" class="mb-4 text-sm"></div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="h-96">
                    <h3 class="text-lg font-medium mb-2 text-gray-600">Button Clicks Chart (Per Page)</h3>
                    <canvas id="pageButtonActivityChart"></canvas>
                </div>
                <div>
                    <h3 class="text-lg font-medium mb-2 text-gray-600">Button Clicks List (Per Page)</h3>
                    <div id="pageButtonActivityListContainer" class="max-h-96 overflow-y-auto border border-gray-200 rounded-md p-3 bg-gray-50">
                        <ul id="pageButtonActivityList" class="list-disc pl-5 text-sm text-gray-700"></ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-lg">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 items-end">
                <div>
                    <label for="startDate" class="block text-sm font-medium text-gray-700">Start Date & Time:</label>
                    <input type="datetime-local" id="startDate" name="startDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                </div>
                <div>
                    <label for="endDate" class="block text-sm font-medium text-gray-700">End Date & Time:</label>
                    <input type="datetime-local" id="endDate" name="endDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                </div>
                <button id="fetchReportButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 h-10">
                    Fetch Report
                </button>
            </div>

            <div id="reportStatus" class="mb-4 text-sm"></div>

            <!-- Toggle for Raw Data Table -->
            <button id="toggleRawDataButton" class="mb-4 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-md text-sm">Show Raw Data Table</button>

            <div id="rawDataTableContainer" class="overflow-x-auto hidden">
                <table class="min-w-full divide-y divide-gray-200 border border-gray-300">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="table-cell table-header">Timestamp</th>
                            <th class="table-cell table-header">Page Name</th>
                            <th class="table-cell table-header">Button Text</th>
                            <th class="table-cell table-header">Button Summary</th>
                            <th class="table-cell table-header">LLM Generated?</th>
                            <th class="table-cell table-header">Originating Button</th>
                            <th class="table-cell table-header">Page Context/Prompt</th>
                        </tr>
                    </thead>
                    <tbody id="reportTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Report data will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Update page title when admin context is ready
        document.addEventListener('adminUserContextReady', async function() {
            if (window.updatePageTitleWithProfile) {
                await window.updatePageTitleWithProfile('User Activity Reports');
            }
        });
    </script>

    <!-- Activity Reports Help Modal -->
    <div id="help-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[1000] flex items-center justify-center p-4" style="z-index: 1000;">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-6 border-b border-gray-200 bg-gradient-to-r from-orange-50 to-red-50 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-clipboard-list text-[#FB4F14] mr-2"></i>Activity Reports Guide
                </h2>
                <button id="close-help-modal" class="text-gray-500 hover:text-gray-700 transition-colors">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6">
                <div class="prose max-w-none">
                    <p class="text-gray-700 mb-6">
                        The Activity Reports page provides comprehensive analytics about user interactions with the AAC system. Track button clicks, page visits, and usage patterns to understand how the user engages with their communication device and identify which features are most utilized.
                    </p>
                    
                    <div class="space-y-3">
                        <!-- Global Page Activity Report -->
                        <div class="settings-guide-item cursor-pointer" onclick="toggleReportGuideDetails(this)">
                            <div class="flex items-start p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                                <div class="flex-shrink-0 mt-1">
                                    <i class="fas fa-globe text-green-600 text-lg"></i>
                                </div>
                                <div class="ml-3 flex-1">
                                    <div class="flex items-center justify-between">
                                        <div class="font-semibold text-gray-900">Global Page Activity Report</div>
                                        <div class="flex items-center space-x-2">
                                            <button onclick="event.stopPropagation(); startReportGuide('global');" class="px-3 py-1 bg-green-500 text-white text-xs rounded-lg hover:bg-green-600 transition flex items-center">
                                                <i class="fas fa-route mr-1"></i>Guide Me
                                            </button>
                                            <i class="fas fa-chevron-down text-gray-400 transition-transform"></i>
                                        </div>
                                    </div>
                                    <div class="guide-details hidden mt-2">
                                        <div class="text-sm text-gray-700 space-y-2">
                                            <p><strong>Purpose:</strong> View overall page usage across the entire AAC system to identify which pages are visited most frequently and which may be unused.</p>
                                            <div class="bg-green-50 border-l-4 border-green-500 p-3 rounded">
                                                <p class="text-sm font-semibold text-green-900 mb-1">What This Report Shows:</p>
                                                <ul class="text-xs text-gray-700 ml-4 space-y-1">
                                                    <li>‚Ä¢ <strong>All Defined Pages:</strong> Every page in the system, even if never visited</li>
                                                    <li>‚Ä¢ <strong>Visit Counts:</strong> Number of times each page was accessed (excludes 'home' page)</li>
                                                    <li>‚Ä¢ <strong>Usage Patterns:</strong> Identifies most popular and unused pages</li>
                                                    <li>‚Ä¢ <strong>Visual Charts:</strong> Bar chart and pie chart for easy comparison</li>
                                                    <li>‚Ä¢ <strong>Date Range Based:</strong> Uses the date range selected in the raw data filters</li>
                                                    <li>‚Ä¢ <strong>Configuration Insights:</strong> Helps identify pages that could be removed or reorganized</li>
                                                </ul>
                                            </div>
                                            <p class="text-xs text-gray-600 mt-2"><i class="fas fa-lightbulb text-yellow-500 mr-1"></i><strong>Use Case:</strong> Identify unused pages to simplify navigation or highlight popular pages for easier access.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Page Specific Button Activity -->
                        <div class="settings-guide-item cursor-pointer" onclick="toggleReportGuideDetails(this)">
                            <div class="flex items-start p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                                <div class="flex-shrink-0 mt-1">
                                    <i class="fas fa-mouse-pointer text-purple-600 text-lg"></i>
                                </div>
                                <div class="ml-3 flex-1">
                                    <div class="flex items-center justify-between">
                                        <div class="font-semibold text-gray-900">Page Specific Button Activity</div>
                                        <div class="flex items-center space-x-2">
                                            <button onclick="event.stopPropagation(); startReportGuide('pageButtons');" class="px-3 py-1 bg-purple-500 text-white text-xs rounded-lg hover:bg-purple-600 transition flex items-center">
                                                <i class="fas fa-route mr-1"></i>Guide Me
                                            </button>
                                            <i class="fas fa-chevron-down text-gray-400 transition-transform"></i>
                                        </div>
                                    </div>
                                    <div class="guide-details hidden mt-2">
                                        <div class="text-sm text-gray-700 space-y-2">
                                            <p><strong>Purpose:</strong> Drill down into a specific page to see which buttons are clicked most often.</p>
                                            <div class="bg-purple-50 border-l-4 border-purple-500 p-3 rounded">
                                                <p class="text-sm font-semibold text-purple-900 mb-1">What This Report Shows:</p>
                                                <ul class="text-xs text-gray-700 ml-4 space-y-1">
                                                    <li>‚Ä¢ <strong>Page Selection:</strong> Choose any page from the dropdown menu</li>
                                                    <li>‚Ä¢ <strong>Static Buttons:</strong> Pre-configured buttons defined in the page setup</li>
                                                    <li>‚Ä¢ <strong>LLM-Generated Buttons:</strong> Dynamic buttons created by AI during conversations</li>
                                                    <li>‚Ä¢ <strong>Click Counts:</strong> Number of times each button was pressed</li>
                                                    <li>‚Ä¢ <strong>Visual Comparison:</strong> Chart showing relative button usage</li>
                                                    <li>‚Ä¢ <strong>Unused Buttons:</strong> Identifies buttons that are never clicked</li>
                                                </ul>
                                            </div>
                                            <p class="text-xs text-gray-600 mt-2"><i class="fas fa-lightbulb text-yellow-500 mr-1"></i><strong>Use Case:</strong> Optimize button placement by moving frequently used buttons to prominent positions.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Date Range Filtering -->
                        <div class="settings-guide-item cursor-pointer" onclick="toggleReportGuideDetails(this)">
                            <div class="flex items-start p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                                <div class="flex-shrink-0 mt-1">
                                    <i class="fas fa-calendar-alt text-blue-600 text-lg"></i>
                                </div>
                                <div class="ml-3 flex-1">
                                    <div class="flex items-center justify-between">
                                        <div class="font-semibold text-gray-900">Date Range Filtering</div>
                                        <div class="flex items-center space-x-2">
                                            <button onclick="event.stopPropagation(); startReportGuide('dateRange');" class="px-3 py-1 bg-blue-500 text-white text-xs rounded-lg hover:bg-blue-600 transition flex items-center">
                                                <i class="fas fa-route mr-1"></i>Guide Me
                                            </button>
                                            <i class="fas fa-chevron-down text-gray-400 transition-transform"></i>
                                        </div>
                                    </div>
                                    <div class="guide-details hidden mt-2">
                                        <div class="text-sm text-gray-700 space-y-2">
                                            <p><strong>Purpose:</strong> Specify a time period to analyze user activity and generate raw data reports.</p>
                                            <div class="bg-blue-50 border-l-4 border-blue-500 p-3 rounded">
                                                <p class="text-sm font-semibold text-blue-900 mb-1">Date Range Features:</p>
                                                <ul class="text-xs text-gray-700 ml-4 space-y-1">
                                                    <li>‚Ä¢ <strong>Start Date & Time:</strong> Beginning of the reporting period (inclusive)</li>
                                                    <li>‚Ä¢ <strong>End Date & Time:</strong> End of the reporting period (inclusive)</li>
                                                    <li>‚Ä¢ <strong>Precise Control:</strong> Select specific dates and times down to the minute</li>
                                                    <li>‚Ä¢ <strong>Affects Global Report:</strong> Page activity counts are based on this date range</li>
                                                    <li>‚Ä¢ <strong>Affects Raw Data:</strong> Detailed click logs are filtered by this range</li>
                                                    <li>‚Ä¢ <strong>Flexible Analysis:</strong> Compare different time periods (week, month, quarter)</li>
                                                </ul>
                                            </div>
                                            <p class="text-xs text-gray-600 mt-2"><i class="fas fa-info-circle text-blue-500 mr-1"></i><strong>Tip:</strong> Start with a broader range (e.g., 1 month), then narrow down to specific periods for detailed analysis.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Raw Data Table -->
                        <div class="settings-guide-item cursor-pointer" onclick="toggleReportGuideDetails(this)">
                            <div class="flex items-start p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                                <div class="flex-shrink-0 mt-1">
                                    <i class="fas fa-table text-indigo-600 text-lg"></i>
                                </div>
                                <div class="ml-3 flex-1">
                                    <div class="flex items-center justify-between">
                                        <div class="font-semibold text-gray-900">Raw Data Table</div>
                                        <div class="flex items-center space-x-2">
                                            <button onclick="event.stopPropagation(); startReportGuide('rawData');" class="px-3 py-1 bg-indigo-500 text-white text-xs rounded-lg hover:bg-indigo-600 transition flex items-center">
                                                <i class="fas fa-route mr-1"></i>Guide Me
                                            </button>
                                            <i class="fas fa-chevron-down text-gray-400 transition-transform"></i>
                                        </div>
                                    </div>
                                    <div class="guide-details hidden mt-2">
                                        <div class="text-sm text-gray-700 space-y-2">
                                            <p><strong>Purpose:</strong> View detailed, chronological log of every button click within the selected date range.</p>
                                            <div class="bg-indigo-50 border-l-4 border-indigo-500 p-3 rounded">
                                                <p class="text-sm font-semibold text-indigo-900 mb-1">Raw Data Columns:</p>
                                                <ul class="text-xs text-gray-700 ml-4 space-y-1">
                                                    <li>‚Ä¢ <strong>Timestamp:</strong> Exact date and time the button was clicked</li>
                                                    <li>‚Ä¢ <strong>Page Name:</strong> Which page the user was viewing</li>
                                                    <li>‚Ä¢ <strong>Button Text:</strong> The text displayed on the clicked button</li>
                                                    <li>‚Ä¢ <strong>Button Summary:</strong> Additional context or category information</li>
                                                    <li>‚Ä¢ <strong>LLM Generated?:</strong> Whether button was AI-created (Yes/No)</li>
                                                    <li>‚Ä¢ <strong>Originating Button:</strong> For LLM buttons, which button triggered the AI conversation</li>
                                                    <li>‚Ä¢ <strong>Page Context/Prompt:</strong> The AI prompt or page context that led to button creation</li>
                                                </ul>
                                            </div>
                                            <p class="text-xs text-gray-600 mt-2"><i class="fas fa-database text-indigo-500 mr-1"></i><strong>Use Case:</strong> Detailed forensic analysis of user behavior, troubleshooting, or understanding communication patterns.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Chart Visualization Options -->
                        <div class="settings-guide-item cursor-pointer" onclick="toggleReportGuideDetails(this)">
                            <div class="flex items-start p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                                <div class="flex-shrink-0 mt-1">
                                    <i class="fas fa-chart-pie text-pink-600 text-lg"></i>
                                </div>
                                <div class="ml-3 flex-1">
                                    <div class="flex items-center justify-between">
                                        <div class="font-semibold text-gray-900">Chart Visualization Options</div>
                                        <div class="flex items-center space-x-2">
                                            <i class="fas fa-chevron-down text-gray-400 transition-transform"></i>
                                        </div>
                                    </div>
                                    <div class="guide-details hidden mt-2">
                                        <div class="text-sm text-gray-700 space-y-2">
                                            <p><strong>Purpose:</strong> Toggle between different chart types for better data visualization.</p>
                                            <div class="bg-pink-50 border-l-4 border-pink-500 p-3 rounded">
                                                <p class="text-sm font-semibold text-pink-900 mb-1">Available Chart Types:</p>
                                                <ul class="text-xs text-gray-700 ml-4 space-y-1">
                                                    <li>‚Ä¢ <strong>Bar Chart (Default):</strong> Best for comparing counts across many items</li>
                                                    <li>‚Ä¢ <strong>Pie Chart:</strong> Shows proportional usage - good for seeing relative distribution</li>
                                                    <li>‚Ä¢ <strong>Toggle Button:</strong> Switch between chart types with "Show Pie Chart" / "Show Bar Chart" button</li>
                                                    <li>‚Ä¢ <strong>Interactive Charts:</strong> Hover over segments for detailed counts</li>
                                                    <li>‚Ä¢ <strong>Both Reports:</strong> Global page report and page-specific button report both support chart toggling</li>
                                                </ul>
                                            </div>
                                            <p class="text-xs text-gray-600 mt-2"><i class="fas fa-lightbulb text-yellow-500 mr-1"></i><strong>Tip:</strong> Use bar charts for detailed comparison, pie charts for quick proportional overview.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Analysis & Insights -->
                        <div class="settings-guide-item cursor-pointer" onclick="toggleReportGuideDetails(this)">
                            <div class="flex items-start p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                                <div class="flex-shrink-0 mt-1">
                                    <i class="fas fa-lightbulb text-yellow-600 text-lg"></i>
                                </div>
                                <div class="ml-3 flex-1">
                                    <div class="flex items-center justify-between">
                                        <div class="font-semibold text-gray-900">Analysis & Insights</div>
                                        <div class="flex items-center space-x-2">
                                            <i class="fas fa-chevron-down text-gray-400 transition-transform"></i>
                                        </div>
                                    </div>
                                    <div class="guide-details hidden mt-2">
                                        <div class="text-sm text-gray-700 space-y-2">
                                            <div class="bg-yellow-50 border-l-4 border-yellow-500 p-3 rounded">
                                                <p class="text-sm font-semibold text-yellow-900 mb-1">How to Interpret Reports:</p>
                                                <div class="text-xs text-gray-700 space-y-3 ml-2">
                                                    <div>
                                                        <p class="font-semibold text-gray-800">üìä High Usage Patterns:</p>
                                                        <ul class="ml-4 mt-1 space-y-1">
                                                            <li>‚Ä¢ Frequently visited pages indicate user interests or needs</li>
                                                            <li>‚Ä¢ High button click counts show preferred communication methods</li>
                                                            <li>‚Ä¢ Consider making high-use features more prominent</li>
                                                        </ul>
                                                    </div>
                                                    <div>
                                                        <p class="font-semibold text-gray-800">üìâ Low/Zero Usage:</p>
                                                        <ul class="ml-4 mt-1 space-y-1">
                                                            <li>‚Ä¢ Pages with zero clicks may be unnecessary or hard to find</li>
                                                            <li>‚Ä¢ Unused buttons could be removed to reduce clutter</li>
                                                            <li>‚Ä¢ Consider user training if important features are unused</li>
                                                        </ul>
                                                    </div>
                                                    <div>
                                                        <p class="font-semibold text-gray-800">ü§ñ LLM-Generated Buttons:</p>
                                                        <ul class="ml-4 mt-1 space-y-1">
                                                            <li>‚Ä¢ High LLM button usage indicates user engages with AI conversations</li>
                                                            <li>‚Ä¢ Frequently generated button types could become permanent buttons</li>
                                                            <li>‚Ä¢ Review originating buttons to understand conversation triggers</li>
                                                        </ul>
                                                    </div>
                                                    <div>
                                                        <p class="font-semibold text-gray-800">‚è∞ Time-Based Analysis:</p>
                                                        <ul class="ml-4 mt-1 space-y-1">
                                                            <li>‚Ä¢ Compare different date ranges to identify trends</li>
                                                            <li>‚Ä¢ Look for changes after configuration modifications</li>
                                                            <li>‚Ä¢ Seasonal or situational patterns (school vs. vacation)</li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Best Practices -->
                        <div class="settings-guide-item cursor-pointer" onclick="toggleReportGuideDetails(this)">
                            <div class="flex items-start p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                                <div class="flex-shrink-0 mt-1">
                                    <i class="fas fa-star text-orange-600 text-lg"></i>
                                </div>
                                <div class="ml-3 flex-1">
                                    <div class="flex items-center justify-between">
                                        <div class="font-semibold text-gray-900">Best Practices & Tips</div>
                                        <div class="flex items-center space-x-2">
                                            <i class="fas fa-chevron-down text-gray-400 transition-transform"></i>
                                        </div>
                                    </div>
                                    <div class="guide-details hidden mt-2">
                                        <div class="text-sm text-gray-700 space-y-2">
                                            <div class="bg-orange-50 border-l-4 border-orange-500 p-3 rounded">
                                                <p class="text-sm font-semibold text-orange-900 mb-1">Reporting Best Practices:</p>
                                                <ul class="text-xs text-gray-700 ml-4 space-y-1">
                                                    <li>‚Ä¢ <strong>Regular Reviews:</strong> Check reports weekly or monthly to spot usage changes</li>
                                                    <li>‚Ä¢ <strong>Baseline First:</strong> Establish normal usage patterns before making changes</li>
                                                    <li>‚Ä¢ <strong>Test Changes:</strong> After modifying pages/buttons, compare before and after reports</li>
                                                    <li>‚Ä¢ <strong>User-Centered:</strong> Focus on what the user actually uses, not what you think they should use</li>
                                                    <li>‚Ä¢ <strong>Remove Clutter:</strong> Eliminate unused pages/buttons to simplify navigation</li>
                                                    <li>‚Ä¢ <strong>Document Decisions:</strong> Keep notes on why you made configuration changes based on reports</li>
                                                    <li>‚Ä¢ <strong>Combine with Observation:</strong> Reports show "what" but observation shows "why"</li>
                                                    <li>‚Ä¢ <strong>Privacy Awareness:</strong> Raw data includes all interactions - handle responsibly</li>
                                                    <li>‚Ä¢ <strong>Date Range Strategy:</strong> Use different ranges for different questions (daily trends vs. monthly patterns)</li>
                                                    <li>‚Ä¢ <strong>Share Insights:</strong> Discuss findings with therapists, teachers, family members</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Workflow Guide -->
                        <div class="settings-guide-item cursor-pointer" onclick="toggleReportGuideDetails(this)">
                            <div class="flex items-start p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                                <div class="flex-shrink-0 mt-1">
                                    <i class="fas fa-project-diagram text-teal-600 text-lg"></i>
                                </div>
                                <div class="ml-3 flex-1">
                                    <div class="flex items-center justify-between">
                                        <div class="font-semibold text-gray-900">Typical Analysis Workflow</div>
                                        <div class="flex items-center space-x-2">
                                            <i class="fas fa-chevron-down text-gray-400 transition-transform"></i>
                                        </div>
                                    </div>
                                    <div class="guide-details hidden mt-2">
                                        <div class="text-sm text-gray-700 space-y-2">
                                            <div class="bg-teal-50 border-l-4 border-teal-500 p-3 rounded">
                                                <p class="text-sm font-semibold text-teal-900 mb-1">Recommended Workflow:</p>
                                                <ol class="text-xs text-gray-700 ml-4 space-y-2" style="list-style-type: decimal;">
                                                    <li><strong>Step 1 - Set Date Range:</strong> Select the time period you want to analyze (start with last 30 days)</li>
                                                    <li><strong>Step 2 - Global Overview:</strong> Click "Generate Global Page Report" to see overall page usage</li>
                                                    <li><strong>Step 3 - Identify Patterns:</strong> Look for heavily used pages and completely unused pages</li>
                                                    <li><strong>Step 4 - Drill Down:</strong> Select high-use pages in the dropdown and generate button reports</li>
                                                    <li><strong>Step 5 - Review Details:</strong> Click "Show Raw Data Table" to see individual interactions</li>
                                                    <li><strong>Step 6 - Take Notes:</strong> Document insights and potential improvements</li>
                                                    <li><strong>Step 7 - Make Changes:</strong> Adjust page configurations based on findings</li>
                                                    <li><strong>Step 8 - Re-Measure:</strong> After changes, generate new reports to validate improvements</li>
                                                </ol>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="p-6 border-t border-gray-200 bg-gray-50 flex justify-between items-center">
                <button id="contact-support-btn" class="text-sm text-[#FB4F14] hover:text-orange-600 transition-colors flex items-center">
                    <i class="fas fa-envelope mr-2"></i>Contact Support
                </button>
                <button id="close-help-modal-footer" class="px-4 py-2 bg-[#FB4F14] text-white rounded-lg hover:bg-orange-600 transition-colors">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Contact Support Modal -->
    <div id="contact-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[1001] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md">
            <div class="p-6 border-b border-gray-200 bg-gradient-to-r from-orange-50 to-red-50">
                <h3 class="text-xl font-bold text-gray-800">
                    <i class="fas fa-envelope text-[#FB4F14] mr-2"></i>Contact Support
                </h3>
            </div>
            
            <div class="p-6">
                <form id="contact-form" action="https://formspree.io/f/xnnqkvqj" method="POST">
                    <div class="space-y-4">
                        <div>
                            <label for="contact-email" class="block text-sm font-medium text-gray-700 mb-1">Your Email</label>
                            <input type="email" id="contact-email" name="email" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                        </div>
                        <div>
                            <label for="contact-message" class="block text-sm font-medium text-gray-700 mb-1">Message</label>
                            <textarea id="contact-message" name="message" rows="4" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"></textarea>
                        </div>
                    </div>
                    
                    <div class="flex gap-3 mt-6">
                        <button type="button" id="cancel-contact" class="flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                            Cancel
                        </button>
                        <button type="submit" class="flex-1 px-4 py-2 bg-[#FB4F14] text-white rounded-lg hover:bg-orange-600 transition-colors">
                            Send Message
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <style>
        /* Guide highlighting animation */
        @keyframes guidePulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(251, 79, 20, 0.7), 0 0 20px rgba(251, 79, 20, 0.4);
                border-color: #FB4F14;
            }
            50% {
                box-shadow: 0 0 0 10px rgba(251, 79, 20, 0), 0 0 30px rgba(251, 79, 20, 0.6);
                border-color: #F97316;
            }
        }
        
        .guide-highlight-target {
            animation: guidePulse 2s ease-in-out infinite;
            position: relative;
            z-index: 1000;
            border: 3px solid #FB4F14 !important;
            border-radius: 8px !important;
        }
    </style>

    <script>
        // Toggle guide details
        function toggleReportGuideDetails(element) {
            const details = element.querySelector('.guide-details');
            const chevron = element.querySelector('.fa-chevron-down');
            
            if (details.classList.contains('hidden')) {
                details.classList.remove('hidden');
                chevron.style.transform = 'rotate(180deg)';
            } else {
                details.classList.add('hidden');
                chevron.style.transform = 'rotate(0deg)';
            }
        }

        // Help modal controls
        const helpIcon = document.getElementById('help-icon');
        const helpModal = document.getElementById('help-modal');
        const closeHelpModal = document.getElementById('close-help-modal');
        const closeHelpModalFooter = document.getElementById('close-help-modal-footer');
        const contactSupportBtn = document.getElementById('contact-support-btn');
        const contactModal = document.getElementById('contact-modal');
        const cancelContact = document.getElementById('cancel-contact');

        function openHelpModal() {
            helpModal.classList.remove('hidden');
        }

        function closeHelpModalFunc() {
            helpModal.classList.add('hidden');
        }

        function openContactModal() {
            contactModal.classList.remove('hidden');
            helpModal.classList.add('hidden');
        }

        function closeContactModal() {
            contactModal.classList.add('hidden');
        }

        helpIcon?.addEventListener('click', openHelpModal, true);
        closeHelpModal?.addEventListener('click', closeHelpModalFunc);
        closeHelpModalFooter?.addEventListener('click', closeHelpModalFunc);
        contactSupportBtn?.addEventListener('click', openContactModal);
        cancelContact?.addEventListener('click', closeContactModal);

        // Close modals on outside click
        helpModal?.addEventListener('click', function(e) {
            if (e.target === helpModal) closeHelpModalFunc();
        });
        contactModal?.addEventListener('click', function(e) {
            if (e.target === contactModal) closeContactModal();
        });

        // Contact form submission
        const contactForm = document.getElementById('contact-form');
        contactForm?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const response = await fetch(contactForm.action, {
                    method: 'POST',
                    body: new FormData(contactForm),
                    headers: { 'Accept': 'application/json' }
                });
                
                if (response.ok) {
                    alert('Thank you for contacting support! We\'ll get back to you soon.');
                    contactForm.reset();
                    closeContactModal();
                } else {
                    alert('There was a problem sending your message. Please try again.');
                }
            } catch (error) {
                alert('There was a problem sending your message. Please try again.');
            }
        });

        // Interactive Guide Objects
        let currentReportGuide = null;

        const globalReportGuide = {
            id: 'global',
            steps: [
                {
                    title: 'Generate Global Page Report',
                    content: 'Click this button to generate a comprehensive report showing visit counts for all pages in the system. The report will display both a chart and a list of pages sorted by usage.',
                    highlight: '#fetchGlobalActivityReportButton',
                    action: function() {
                        const btn = document.getElementById('fetchGlobalActivityReportButton');
                        if (btn) {
                            btn.classList.add('guide-highlight-target');
                            btn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    },
                    cleanup: function() {
                        const btn = document.getElementById('fetchGlobalActivityReportButton');
                        if (btn) btn.classList.remove('guide-highlight-target');
                    }
                },
                {
                    title: 'Toggle Chart Type',
                    content: 'Use this button to switch between bar chart and pie chart views. Bar charts are better for comparing many items, while pie charts show proportional usage at a glance.',
                    highlight: '#toggleGlobalChartTypeButton',
                    action: function() {
                        const btn = document.getElementById('toggleGlobalChartTypeButton');
                        if (btn) {
                            btn.classList.add('guide-highlight-target');
                            btn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    },
                    cleanup: function() {
                        const btn = document.getElementById('toggleGlobalChartTypeButton');
                        if (btn) btn.classList.remove('guide-highlight-target');
                    }
                },
                {
                    title: 'Review Page Activity Chart',
                    content: 'This chart visualizes page visit counts. Taller bars (or larger pie slices) indicate more frequently visited pages. Hover over chart elements to see exact counts.',
                    highlight: '#globalPageActivityChart',
                    action: function() {
                        const chart = document.getElementById('globalPageActivityChart');
                        if (chart) {
                            chart.classList.add('guide-highlight-target');
                            chart.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    },
                    cleanup: function() {
                        const chart = document.getElementById('globalPageActivityChart');
                        if (chart) chart.classList.remove('guide-highlight-target');
                    }
                },
                {
                    title: 'Review Page Activity List',
                    content: 'This list shows all pages with their visit counts in descending order. Pages with zero visits may be candidates for removal or reorganization to simplify navigation.',
                    highlight: '#globalPageActivityListContainer',
                    action: function() {
                        const list = document.getElementById('globalPageActivityListContainer');
                        if (list) {
                            list.classList.add('guide-highlight-target');
                            list.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    },
                    cleanup: function() {
                        const list = document.getElementById('globalPageActivityListContainer');
                        if (list) list.classList.remove('guide-highlight-target');
                    }
                }
            ]
        };

        const pageButtonsGuide = {
            id: 'pageButtons',
            steps: [
                {
                    title: 'Select a Page',
                    content: 'Choose a specific page from this dropdown to analyze button usage on that page. Select pages that showed high activity in the global report to understand which buttons are most popular.',
                    highlight: '#pageSelectorDropdown',
                    action: function() {
                        const dropdown = document.getElementById('pageSelectorDropdown');
                        if (dropdown) {
                            dropdown.classList.add('guide-highlight-target');
                            dropdown.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    },
                    cleanup: function() {
                        const dropdown = document.getElementById('pageSelectorDropdown');
                        if (dropdown) dropdown.classList.remove('guide-highlight-target');
                    }
                },
                {
                    title: 'Generate Page Button Report',
                    content: 'Click this button to generate a report showing button click counts for the selected page. The report includes both pre-configured static buttons and AI-generated dynamic buttons.',
                    highlight: '#fetchPageButtonReportButton',
                    action: function() {
                        const btn = document.getElementById('fetchPageButtonReportButton');
                        if (btn) {
                            btn.classList.add('guide-highlight-target');
                            btn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    },
                    cleanup: function() {
                        const btn = document.getElementById('fetchPageButtonReportButton');
                        if (btn) btn.classList.remove('guide-highlight-target');
                    }
                },
                {
                    title: 'Review Button Activity Chart',
                    content: 'This chart shows click counts for each button on the selected page. Identify which buttons are used most often and which are never clicked.',
                    highlight: '#pageButtonActivityChart',
                    action: function() {
                        const chart = document.getElementById('pageButtonActivityChart');
                        if (chart) {
                            chart.classList.add('guide-highlight-target');
                            chart.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    },
                    cleanup: function() {
                        const chart = document.getElementById('pageButtonActivityChart');
                        if (chart) chart.classList.remove('guide-highlight-target');
                    }
                },
                {
                    title: 'Review Button Activity List',
                    content: 'This list provides detailed button names and click counts. Use this to identify specific buttons that should be moved, removed, or made more prominent based on usage.',
                    highlight: '#pageButtonActivityListContainer',
                    action: function() {
                        const list = document.getElementById('pageButtonActivityListContainer');
                        if (list) {
                            list.classList.add('guide-highlight-target');
                            list.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    },
                    cleanup: function() {
                        const list = document.getElementById('pageButtonActivityListContainer');
                        if (list) list.classList.remove('guide-highlight-target');
                    }
                }
            ]
        };

        const dateRangeRawDataGuide = {
            id: 'dateRangeRawData',
            steps: [
                {
                    title: 'Set Start Date & Time',
                    content: 'Click this field to select the beginning of your analysis period. You can choose both the date and specific time. For general analysis, set this to the beginning of the period you want to review (e.g., first day of the month).',
                    highlight: '#startDate',
                    action: function() {
                        const startDate = document.getElementById('startDate');
                        if (startDate) {
                            startDate.classList.add('guide-highlight-target');
                            startDate.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    },
                    cleanup: function() {
                        const startDate = document.getElementById('startDate');
                        if (startDate) startDate.classList.remove('guide-highlight-target');
                    }
                },
                {
                    title: 'Set End Date & Time',
                    content: 'Click this field to select the end of your analysis period. This is typically set to today or the end of the time period you\'re analyzing. The date range is inclusive of both start and end.',
                    highlight: '#endDate',
                    action: function() {
                        const endDate = document.getElementById('endDate');
                        if (endDate) {
                            endDate.classList.add('guide-highlight-target');
                            endDate.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    },
                    cleanup: function() {
                        const endDate = document.getElementById('endDate');
                        if (endDate) endDate.classList.remove('guide-highlight-target');
                    }
                },
                {
                    title: 'Fetch Raw Data Report',
                    content: 'After setting your date range, click this button to retrieve the raw click data. This data is used by both the global page report and will populate the raw data table when you toggle it visible.',
                    highlight: '#fetchReportButton',
                    action: function() {
                        const btn = document.getElementById('fetchReportButton');
                        if (btn) {
                            btn.classList.add('guide-highlight-target');
                            btn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    },
                    cleanup: function() {
                        const btn = document.getElementById('fetchReportButton');
                        if (btn) btn.classList.remove('guide-highlight-target');
                    }
                },
                {
                    title: 'Toggle Raw Data Table',
                    content: 'Click this button to show or hide the detailed raw data table. The table displays every button click within your selected date range with complete details including timestamps, page names, and button information.',
                    highlight: '#toggleRawDataButton',
                    action: function() {
                        const btn = document.getElementById('toggleRawDataButton');
                        if (btn) {
                            btn.classList.add('guide-highlight-target');
                            btn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    },
                    cleanup: function() {
                        const btn = document.getElementById('toggleRawDataButton');
                        if (btn) btn.classList.remove('guide-highlight-target');
                    }
                },
                {
                    title: 'Review Raw Data Table',
                    content: 'This table shows every individual button click as a separate row. Use this for detailed forensic analysis, troubleshooting specific user behaviors, or understanding the exact sequence of interactions. The table includes timestamps, page context, button details, and information about LLM-generated buttons.',
                    highlight: '#rawDataTableContainer',
                    action: function() {
                        const table = document.getElementById('rawDataTableContainer');
                        if (table) {
                            table.classList.add('guide-highlight-target');
                            table.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    },
                    cleanup: function() {
                        const table = document.getElementById('rawDataTableContainer');
                        if (table) table.classList.remove('guide-highlight-target');
                    }
                }
            ]
        };

        // Start guide function
        function startReportGuide(guideId) {
            console.log('Starting report guide for:', guideId);
            
            closeHelpModalFunc();
            
            const guides = {
                'global': globalReportGuide,
                'pageButtons': pageButtonsGuide,
                'dateRange': dateRangeRawDataGuide,
                'rawData': dateRangeRawDataGuide
            };
            
            const guide = guides[guideId];
            if (guide) {
                currentReportGuide = {
                    guide: guide,
                    currentStep: 0
                };
                showReportGuideWindow();
            }
        }

        // Guide window functions
        function showReportGuideWindow() {
            if (!currentReportGuide) return;
            
            let guideWindow = document.getElementById('report-guide-window');
            if (!guideWindow) {
                guideWindow = document.createElement('div');
                guideWindow.id = 'report-guide-window';
                guideWindow.style.cssText = 'position: fixed; bottom: 20px; right: 20px; width: 400px; max-height: 500px; background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 9999; display: flex; flex-direction: column;';
                
                guideWindow.innerHTML = `
                    <div style="background: linear-gradient(135deg, #FB4F14 0%, #F97316 100%); color: white; padding: 16px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div id="report-guide-title" style="font-weight: bold; font-size: 18px;"></div>
                            <div id="report-guide-progress" style="font-size: 12px; opacity: 0.9; margin-top: 4px;"></div>
                        </div>
                        <button id="report-guide-close" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 0; width: 32px; height: 32px;">&times;</button>
                    </div>
                    <div id="report-guide-content" style="padding: 20px; flex: 1; overflow-y: auto;"></div>
                    <div style="border-top: 1px solid #e5e7eb; padding: 16px; display: flex; justify-content: space-between; align-items: center; background: #f9fafb; border-radius: 0 0 12px 12px;">
                        <button id="report-guide-prev" style="padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                            <i class="fas fa-arrow-left"></i> Previous
                        </button>
                        <div id="report-guide-step-indicator" style="display: flex; gap: 8px;"></div>
                        <button id="report-guide-next" style="padding: 8px 16px; background: #FB4F14; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                            Next <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                `;
                
                document.body.appendChild(guideWindow);
                
                document.getElementById('report-guide-close').addEventListener('click', closeReportGuide);
                document.getElementById('report-guide-prev').addEventListener('click', previousReportGuideStep);
                document.getElementById('report-guide-next').addEventListener('click', nextReportGuideStep);
            }
            
            guideWindow.style.display = 'flex';
            updateReportGuideStep();
        }

        function updateReportGuideStep() {
            if (!currentReportGuide) return;
            
            const guide = currentReportGuide.guide;
            const step = guide.steps[currentReportGuide.currentStep];
            
            document.getElementById('report-guide-title').textContent = step.title;
            document.getElementById('report-guide-progress').textContent = `Step ${currentReportGuide.currentStep + 1} of ${guide.steps.length}`;
            document.getElementById('report-guide-content').innerHTML = `<p style="color: #374151; line-height: 1.6;">${step.content}</p>`;
            
            const indicatorContainer = document.getElementById('report-guide-step-indicator');
            indicatorContainer.innerHTML = '';
            for (let i = 0; i < guide.steps.length; i++) {
                const dot = document.createElement('div');
                dot.style.cssText = 'width: 10px; height: 10px; border-radius: 50%; transition: all 0.3s;';
                if (i < currentReportGuide.currentStep) {
                    dot.style.background = '#10b981';
                } else if (i === currentReportGuide.currentStep) {
                    dot.style.background = '#FB4F14';
                    dot.style.transform = 'scale(1.3)';
                } else {
                    dot.style.background = '#d1d5db';
                }
                indicatorContainer.appendChild(dot);
            }
            
            const prevBtn = document.getElementById('report-guide-prev');
            const nextBtn = document.getElementById('report-guide-next');
            
            prevBtn.disabled = currentReportGuide.currentStep === 0;
            prevBtn.style.opacity = prevBtn.disabled ? '0.5' : '1';
            prevBtn.style.cursor = prevBtn.disabled ? 'not-allowed' : 'pointer';
            
            const isLastStep = currentReportGuide.currentStep === guide.steps.length - 1;
            nextBtn.innerHTML = isLastStep ? 'Complete <i class="fas fa-check"></i>' : 'Next <i class="fas fa-arrow-right"></i>';
            
            if (step.action) {
                if (currentReportGuide.currentStep > 0) {
                    const prevStep = guide.steps[currentReportGuide.currentStep - 1];
                    if (prevStep.cleanup) prevStep.cleanup();
                }
                step.action();
            }
        }

        function nextReportGuideStep() {
            if (!currentReportGuide) return;
            
            const guide = currentReportGuide.guide;
            
            if (currentReportGuide.currentStep < guide.steps.length - 1) {
                currentReportGuide.currentStep++;
                updateReportGuideStep();
            } else {
                closeReportGuide();
            }
        }

        function previousReportGuideStep() {
            if (!currentReportGuide) return;
            
            if (currentReportGuide.currentStep > 0) {
                currentReportGuide.currentStep--;
                updateReportGuideStep();
            }
        }

        function closeReportGuide() {
            if (!currentReportGuide) return;
            
            const guide = currentReportGuide.guide;
            const step = guide.steps[currentReportGuide.currentStep];
            if (step.cleanup) step.cleanup();
            
            const guideWindow = document.getElementById('report-guide-window');
            if (guideWindow) guideWindow.style.display = 'none';
            
            currentReportGuide = null;
        }
    </script>

</body>
</html>