<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Management - Delete Unwanted Images</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    
    <style>
        .image-card {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .image-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .image-card.selected {
            border-color: #ef4444;
            background-color: #fef2f2;
        }
        .image-preview {
            width: 200px;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
        }
        .loading-spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .bulk-actions {
            position: sticky;
            top: 0;
            z-index: 10;
            background: white;
            border-bottom: 1px solid #e5e7eb;
        }
        .tag-item {
            transition: all 0.2s ease;
        }
        .tag-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .tag-row {
            transition: all 0.2s ease;
        }
        .tag-row:hover {
            background-color: #f9fafb;
        }
        .tag-input {
            transition: all 0.2s ease;
        }
        .tag-input:focus {
            transform: scale(1.02);
        }
        .search-filters {
            background: #f9fafb;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Page Header -->
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <a href="admin_pages.html" class="text-gray-600 hover:text-gray-900">
                        <i class="fas fa-arrow-left"></i> Back to Admin
                    </a>
                    <h1 class="text-2xl font-bold text-gray-900">Image Management</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="status-indicator" class="text-sm text-gray-500"></div>
                    <button id="refresh-button" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        
        <!-- Bulk Actions Bar -->
        <div id="bulk-actions" class="bulk-actions hidden">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <span id="selected-count" class="text-sm font-medium text-gray-700">0 images selected</span>
                    <button id="select-all-button" class="text-blue-600 hover:text-blue-800 text-sm">
                        Select All on Page
                    </button>
                    <button id="clear-selection-button" class="text-gray-600 hover:text-gray-800 text-sm">
                        Clear Selection
                    </button>
                </div>
                <div class="flex items-center space-x-2">
                    <button id="delete-selected-button" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-trash mr-2"></i>Delete Selected
                    </button>
                </div>
            </div>
        </div>

        <!-- Search and Filters -->
        <div class="search-filters">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Search Images</label>
                    <input type="text" id="search-input" placeholder="Search by concept, subconcept, or tags..." 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Filter by Concept</label>
                    <select id="concept-filter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">All Concepts</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Sort By</label>
                    <select id="sort-select" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="created_at_desc">Newest First</option>
                        <option value="created_at_asc">Oldest First</option>
                        <option value="concept_asc">Concept A-Z</option>
                        <option value="subconcept_asc">Subconcept A-Z</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button id="apply-filters-button" class="w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                        <i class="fas fa-filter mr-2"></i>Apply Filters
                    </button>
                </div>
            </div>
        </div>

        <!-- Stats Bar -->
        <div class="bg-white rounded-lg p-4 mb-6 shadow-sm">
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
                <div>
                    <div id="total-images" class="text-2xl font-bold text-blue-600">-</div>
                    <div class="text-sm text-gray-500">Total Images</div>
                </div>
                <div>
                    <div id="displayed-images" class="text-2xl font-bold text-green-600">-</div>
                    <div class="text-sm text-gray-500">Displayed</div>
                </div>
                <div>
                    <div id="selected-images" class="text-2xl font-bold text-red-600">-</div>
                    <div class="text-sm text-gray-500">Selected for Deletion</div>
                </div>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="flex justify-center items-center py-12">
            <div class="loading-spinner"></div>
            <span class="ml-3 text-gray-600">Loading images...</span>
        </div>

        <!-- Images Grid -->
        <div id="images-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 hidden">
            <!-- Images will be populated here -->
        </div>

        <!-- No Results -->
        <div id="no-results" class="text-center py-12 hidden">
            <i class="fas fa-search text-4xl text-gray-300 mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No images found</h3>
            <p class="text-gray-500">Try adjusting your search criteria or filters.</p>
        </div>

        <!-- Pagination -->
        <div id="pagination" class="flex justify-center items-center space-x-4 mt-8 hidden">
            <button id="prev-page" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fas fa-chevron-left mr-2"></i>Previous
            </button>
            <span id="page-info" class="text-sm text-gray-600">Page 1 of 1</span>
            <button id="next-page" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                Next<i class="fas fa-chevron-right ml-2"></i>
            </button>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <div class="flex items-center mb-4">
                <i class="fas fa-exclamation-triangle text-red-500 text-2xl mr-3"></i>
                <h3 class="text-lg font-semibold text-gray-900">Confirm Deletion</h3>
            </div>
            <p class="text-gray-600 mb-6">
                Are you sure you want to permanently delete <span id="delete-count" class="font-semibold">0</span> selected image(s)? 
                This action cannot be undone.
            </p>
            <div class="flex justify-end space-x-3">
                <button id="cancel-delete" class="px-4 py-2 text-gray-600 bg-gray-200 rounded-lg hover:bg-gray-300">
                    Cancel
                </button>
                <button id="confirm-delete" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                    Delete Images
                </button>
            </div>
        </div>
    </div>

    <!-- Image Preview Modal -->
    <div id="preview-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Image Details</h3>
                <button id="close-preview" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="preview-content">
                <!-- Preview content will be populated here -->
            </div>
        </div>
    </div>

    <!-- Tag Editor Modal -->
    <div id="tag-editor-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg max-w-lg w-full mx-4 max-h-[80vh] flex flex-col">
            <!-- Modal Header (Fixed) -->
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-lg font-semibold text-gray-900">Edit Image Tags</h3>
                <button id="close-tag-editor" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <!-- Modal Content (Scrollable) -->
            <div class="flex-1 overflow-y-auto p-4">
                <div class="mb-4">
                    <img id="tag-editor-image" class="w-24 h-24 object-cover rounded-lg mx-auto mb-2" />
                    <div class="text-center">
                        <p class="text-sm text-gray-600" id="tag-editor-concept"></p>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Current Tags (click to edit):</label>
                    <div id="current-tags" class="space-y-2 mb-4 min-h-[40px] max-h-[240px] overflow-y-auto p-2 border rounded-lg bg-gray-50">
                        <!-- Current tags will be displayed here -->
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Add New Tag:</label>
                    <div class="flex gap-2">
                        <input type="text" id="new-tag-input" 
                               class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                               placeholder="Enter a new tag..."
                               onkeypress="if(event.key==='Enter') addTag()">
                        <button onclick="addTag()" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>
                </div>
            </div>

            <!-- Modal Footer (Fixed) -->
            <div class="flex justify-end space-x-3 p-4 border-t bg-gray-50">
                <button onclick="closeTagEditor()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                    Cancel
                </button>
                <button onclick="saveImageTags()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    <i class="fas fa-save"></i> Save Tags
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let allImages = [];
        let displayedImages = [];
        let selectedImages = new Set();
        let currentPage = 1;
        let itemsPerPage = 50;
        let concepts = [];
        
        // Authentication variables
        let firebaseIdToken = null;
        let currentAacUserId = null;
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', async function() {
            await initializeAuth();
            await loadImages();
            setupEventListeners();
        });
        
        async function initializeAuth() {
            try {
                // Get Firebase config
                const response = await fetch('/api/frontend-config');
                if (!response.ok) throw new Error(`Server error (${response.status})`);
                const firebaseConfig = await response.json();
                
                // Initialize Firebase
                firebase.initializeApp(firebaseConfig);
                const auth = firebase.auth();
                
                // Check authentication
                return new Promise((resolve, reject) => {
                    auth.onAuthStateChanged(async (user) => {
                        if (user) {
                            currentAacUserId = sessionStorage.getItem("currentAacUserId");
                            firebaseIdToken = await user.getIdToken();
                            
                            if (!currentAacUserId) {
                                console.warn("No AAC User ID found. Redirecting to auth.");
                                window.location.href = 'auth.html';
                                return;
                            }
                            
                            console.log("Authentication successful");
                            resolve();
                        } else {
                            console.warn("No user session. Redirecting to auth.");
                            window.location.href = 'auth.html';
                            reject(new Error("Not authenticated"));
                        }
                    });
                });
            } catch (error) {
                console.error("Authentication error:", error);
                window.location.href = 'auth.html';
            }
        }
        
        async function authenticatedFetch(url, options = {}) {
            const headers = options.headers || {};
            headers['Authorization'] = `Bearer ${firebaseIdToken}`;
            options.headers = headers;
            
            const response = await fetch(url, options);
            if (response.status === 401 || response.status === 403) {
                console.warn("Authentication failed. Redirecting to login.");
                window.location.href = 'auth.html';
                throw new Error("Authentication required");
            }
            return response;
        }
        
        async function loadImages() {
            try {
                showLoading(true);
                updateStatus("Loading images...");
                
                const response = await authenticatedFetch('/api/admin/images/browse?limit=5000&source=all');
                if (!response.ok) {
                    throw new Error(`Failed to load images: ${response.status}`);
                }
                
                const data = await response.json();
                allImages = data.images || [];
                
                // Extract unique concepts for filter
                concepts = [...new Set(allImages.map(img => img.concept))].sort();
                populateConceptFilter();
                
                applyFiltersAndSort();
                updateStats();
                updateStatus(`Loaded ${allImages.length} images`);
                
            } catch (error) {
                console.error("Error loading images:", error);
                updateStatus("Error loading images");
                showError("Failed to load images. Please try again.");
            } finally {
                showLoading(false);
            }
        }
        
        function populateConceptFilter() {
            const conceptFilter = document.getElementById('concept-filter');
            conceptFilter.innerHTML = '<option value="">All Concepts</option>';
            
            concepts.forEach(concept => {
                const option = document.createElement('option');
                option.value = concept;
                option.textContent = concept.charAt(0).toUpperCase() + concept.slice(1);
                conceptFilter.appendChild(option);
            });
        }
        
        function applyFiltersAndSort() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const conceptFilter = document.getElementById('concept-filter').value;
            const sortBy = document.getElementById('sort-select').value;
            
            // Apply filters
            displayedImages = allImages.filter(image => {
                // Search filter
                if (searchTerm) {
                    const searchableText = [
                        image.concept || '',
                        image.subconcept || '',
                        ...(image.tags || [])
                    ].join(' ').toLowerCase();
                    
                    if (!searchableText.includes(searchTerm)) {
                        return false;
                    }
                }
                
                // Concept filter
                if (conceptFilter && image.concept !== conceptFilter) {
                    return false;
                }
                
                return true;
            });
            
            // Apply sorting
            displayedImages.sort((a, b) => {
                switch (sortBy) {
                    case 'created_at_desc':
                        return new Date(b.created_at || 0) - new Date(a.created_at || 0);
                    case 'created_at_asc':
                        return new Date(a.created_at || 0) - new Date(b.created_at || 0);
                    case 'concept_asc':
                        return (a.concept || '').localeCompare(b.concept || '');
                    case 'subconcept_asc':
                        return (a.subconcept || '').localeCompare(b.subconcept || '');
                    default:
                        return 0;
                }
            });
            
            currentPage = 1;
            renderImages();
            updateStats();
        }
        
        function renderImages() {
            const grid = document.getElementById('images-grid');
            const noResults = document.getElementById('no-results');
            const pagination = document.getElementById('pagination');
            
            if (displayedImages.length === 0) {
                grid.classList.add('hidden');
                noResults.classList.remove('hidden');
                pagination.classList.add('hidden');
                return;
            }
            
            noResults.classList.add('hidden');
            grid.classList.remove('hidden');
            
            // Calculate pagination
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, displayedImages.length);
            const pageImages = displayedImages.slice(startIndex, endIndex);
            
            // Render images
            grid.innerHTML = '';
            pageImages.forEach(image => {
                const imageCard = createImageCard(image);
                grid.appendChild(imageCard);
            });
            
            // Update pagination
            updatePagination();
        }
        
        function createImageCard(image) {
            const card = document.createElement('div');
            card.className = `image-card bg-white rounded-lg p-4 shadow-sm cursor-pointer ${selectedImages.has(image.id) ? 'selected' : ''}`;
            card.dataset.imageId = image.id;
            
            card.innerHTML = `
                <div class="relative">
                    <img src="${image.image_url}" alt="${image.subconcept}" 
                         class="image-preview w-full h-48 object-cover rounded-lg mb-3"
                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjNmNGY2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtc2l6ZT0iMTgiIGZpbGw9IiM5Y2EzYWYiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5JbWFnZSBOb3QgRm91bmQ8L3RleHQ+PC9zdmc+'">
                    
                    <!-- Selection checkbox -->
                    <div class="absolute top-2 right-2">
                        <input type="checkbox" class="image-checkbox w-5 h-5 text-red-600 rounded focus:ring-red-500" 
                               ${selectedImages.has(image.id) ? 'checked' : ''}>
                    </div>
                    
                    <!-- Preview button -->
                    <button class="preview-button absolute top-2 left-2 bg-black bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-75 transition-all">
                        <i class="fas fa-eye text-sm"></i>
                    </button>
                </div>
                
                <div class="space-y-2">
                    <h3 class="font-medium text-gray-900 truncate" title="${image.subconcept}">${image.subconcept}</h3>
                    <p class="text-sm text-gray-600 truncate" title="${image.concept}">
                        <i class="fas fa-folder mr-1"></i>${image.concept}
                    </p>
                    <div class="flex flex-wrap gap-1">
                        ${(image.tags || []).slice(0, 3).map(tag => 
                            `<span class="inline-block bg-gray-100 text-gray-700 text-xs px-2 py-1 rounded-full">${tag}</span>`
                        ).join('')}
                        ${(image.tags || []).length > 3 ? `<span class="text-xs text-gray-500">+${(image.tags || []).length - 3} more</span>` : ''}
                    </div>
                    <p class="text-xs text-gray-500">
                        <i class="fas fa-calendar mr-1"></i>
                        ${image.created_at ? new Date(image.created_at).toLocaleDateString() : 'Unknown date'}
                    </p>
                </div>
            `;
            
            // Add event listeners
            const checkbox = card.querySelector('.image-checkbox');
            const previewButton = card.querySelector('.preview-button');
            
            checkbox.addEventListener('change', (e) => {
                e.stopPropagation();
                toggleImageSelection(image.id, e.target.checked);
            });
            
            previewButton.addEventListener('click', (e) => {
                e.stopPropagation();
                showImagePreview(image);
            });
            
            card.addEventListener('click', (e) => {
                if (e.target === checkbox || e.target === previewButton) return;
                const isSelected = selectedImages.has(image.id);
                toggleImageSelection(image.id, !isSelected);
                checkbox.checked = !isSelected;
            });
            
            return card;
        }
        
        function toggleImageSelection(imageId, selected) {
            if (selected) {
                selectedImages.add(imageId);
            } else {
                selectedImages.delete(imageId);
            }
            
            updateSelectionUI();
            updateStats();
        }
        
        function updateSelectionUI() {
            const selectedCount = selectedImages.size;
            const bulkActions = document.getElementById('bulk-actions');
            const selectedCountElement = document.getElementById('selected-count');
            const deleteButton = document.getElementById('delete-selected-button');
            
            if (selectedCount > 0) {
                bulkActions.classList.remove('hidden');
                selectedCountElement.textContent = `${selectedCount} image${selectedCount === 1 ? '' : 's'} selected`;
                deleteButton.disabled = false;
            } else {
                bulkActions.classList.add('hidden');
                deleteButton.disabled = true;
            }
            
            // Update card selection states
            document.querySelectorAll('.image-card').forEach(card => {
                const imageId = card.dataset.imageId;
                const checkbox = card.querySelector('.image-checkbox');
                
                if (selectedImages.has(imageId)) {
                    card.classList.add('selected');
                    checkbox.checked = true;
                } else {
                    card.classList.remove('selected');
                    checkbox.checked = false;
                }
            });
        }
        
        function updateStats() {
            document.getElementById('total-images').textContent = allImages.length.toLocaleString();
            document.getElementById('displayed-images').textContent = displayedImages.length.toLocaleString();
            document.getElementById('selected-images').textContent = selectedImages.size.toLocaleString();
        }
        
        function updatePagination() {
            const totalPages = Math.ceil(displayedImages.length / itemsPerPage);
            const pagination = document.getElementById('pagination');
            const pageInfo = document.getElementById('page-info');
            const prevButton = document.getElementById('prev-page');
            const nextButton = document.getElementById('next-page');
            
            if (totalPages <= 1) {
                pagination.classList.add('hidden');
                return;
            }
            
            pagination.classList.remove('hidden');
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            prevButton.disabled = currentPage === 1;
            nextButton.disabled = currentPage === totalPages;
        }
        
        function showImagePreview(image) {
            const modal = document.getElementById('preview-modal');
            const content = document.getElementById('preview-content');
            
            content.innerHTML = `
                <div class="text-center mb-4">
                    <img src="${image.image_url}" alt="${image.subconcept}" 
                         class="max-w-full max-h-64 mx-auto rounded-lg shadow-lg"
                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjNmNGY2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtc2l6ZT0iMjAiIGZpbGw9IiM5Y2EzYWYiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5JbWFnZSBOb3QgRm91bmQ8L3RleHQ+PC9zdmc+'">
                </div>
                
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <label class="font-medium text-gray-700">Subconcept:</label>
                            <p class="text-gray-900">${image.subconcept || 'N/A'}</p>
                        </div>
                        <div>
                            <label class="font-medium text-gray-700">Concept:</label>
                            <p class="text-gray-900">${image.concept || 'N/A'}</p>
                        </div>
                        <div>
                            <label class="font-medium text-gray-700">Created:</label>
                            <p class="text-gray-900">${image.created_at ? new Date(image.created_at).toLocaleString() : 'Unknown'}</p>
                        </div>
                        <div>
                            <label class="font-medium text-gray-700">Image ID:</label>
                            <p class="text-gray-900 font-mono text-xs">${image.id}</p>
                        </div>
                    </div>
                    
                    <div>
                        <label class="font-medium text-gray-700">Tags:</label>
                        <div class="flex flex-wrap gap-2 mt-1">
                            ${(image.tags || []).map(tag => 
                                `<span class="inline-block bg-blue-100 text-blue-800 text-sm px-3 py-1 rounded-full">${tag}</span>`
                            ).join('')}
                        </div>
                    </div>
                    
                    <div>
                        <label class="font-medium text-gray-700">Image URL:</label>
                        <p class="text-gray-600 text-xs break-all">${image.image_url}</p>
                    </div>
                    
                    <div class="flex justify-center space-x-3 pt-4">
                        <button onclick="toggleImageSelection('${image.id}', !selectedImages.has('${image.id}')); updateSelectionUI();" 
                                class="px-4 py-2 ${selectedImages.has(image.id) ? 'bg-gray-500 text-white' : 'bg-red-600 text-white'} rounded-lg hover:opacity-80">
                            ${selectedImages.has(image.id) ? 'Remove from Selection' : 'Select for Deletion'}
                        </button>
                        <button onclick="openTagEditor('${image.id}')" 
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Edit Tags
                        </button>
                        <button onclick="deleteImage('${image.id}')" 
                                class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                            Delete This Image
                        </button>
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
        
        async function deleteImage(imageId) {
            if (!confirm('Are you sure you want to delete this image? This action cannot be undone.')) {
                return;
            }
            
            try {
                updateStatus("Deleting image...");
                
                const response = await authenticatedFetch(`/api/admin/images/${imageId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to delete image: ${response.status}`);
                }
                
                // Remove from local data
                allImages = allImages.filter(img => img.id !== imageId);
                selectedImages.delete(imageId);
                
                // Close preview modal
                document.getElementById('preview-modal').classList.add('hidden');
                
                // Refresh display
                applyFiltersAndSort();
                updateStatus("Image deleted successfully");
                
            } catch (error) {
                console.error("Error deleting image:", error);
                showError("Failed to delete image. Please try again.");
                updateStatus("Error deleting image");
            }
        }
        
        async function deleteSelectedImages() {
            const selectedIds = Array.from(selectedImages);
            const deleteCount = selectedIds.length;
            
            if (deleteCount === 0) return;
            
            // Show confirmation modal
            document.getElementById('delete-count').textContent = deleteCount;
            document.getElementById('delete-modal').classList.remove('hidden');
            document.getElementById('delete-modal').classList.add('flex');
        }
        
        async function confirmDeleteSelected() {
            const selectedIds = Array.from(selectedImages);
            const deleteCount = selectedIds.length;
            
            try {
                updateStatus(`Deleting ${deleteCount} images...`);
                
                // Use bulk delete API for efficiency
                const response = await authenticatedFetch('/api/admin/images/bulk-delete', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(selectedIds)
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to delete images: ${response.status}`);
                }
                
                const result = await response.json();
                
                // Remove successfully deleted images from local data
                allImages = allImages.filter(img => !selectedIds.includes(img.id));
                selectedImages.clear();
                
                // Close modal and refresh
                document.getElementById('delete-modal').classList.add('hidden');
                applyFiltersAndSort();
                
                if (result.failed_deletions && result.failed_deletions.length > 0) {
                    updateStatus(`Deleted ${result.deleted_count} images, ${result.failed_deletions.length} failed`);
                    console.warn('Failed deletions:', result.failed_deletions);
                } else {
                    updateStatus(`Successfully deleted ${result.deleted_count} images`);
                }
                
            } catch (error) {
                console.error("Error deleting images:", error);
                showError("Failed to delete images. Please try again.");
                updateStatus("Error deleting images");
            }
        }
        
        function setupEventListeners() {
            // Filter and search
            document.getElementById('apply-filters-button').addEventListener('click', applyFiltersAndSort);
            document.getElementById('search-input').addEventListener('keyup', (e) => {
                if (e.key === 'Enter') applyFiltersAndSort();
            });
            
            // Bulk actions
            document.getElementById('select-all-button').addEventListener('click', () => {
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = Math.min(startIndex + itemsPerPage, displayedImages.length);
                const pageImages = displayedImages.slice(startIndex, endIndex);
                
                pageImages.forEach(image => selectedImages.add(image.id));
                updateSelectionUI();
                updateStats();
            });
            
            document.getElementById('clear-selection-button').addEventListener('click', () => {
                selectedImages.clear();
                updateSelectionUI();
                updateStats();
            });
            
            document.getElementById('delete-selected-button').addEventListener('click', deleteSelectedImages);
            
            // Pagination
            document.getElementById('prev-page').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderImages();
                }
            });
            
            document.getElementById('next-page').addEventListener('click', () => {
                const totalPages = Math.ceil(displayedImages.length / itemsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    renderImages();
                }
            });
            
            // Refresh
            document.getElementById('refresh-button').addEventListener('click', loadImages);
            
            // Modal controls
            document.getElementById('close-preview').addEventListener('click', () => {
                document.getElementById('preview-modal').classList.add('hidden');
                document.getElementById('preview-modal').classList.remove('flex');
            });
            
            document.getElementById('cancel-delete').addEventListener('click', () => {
                document.getElementById('delete-modal').classList.add('hidden');
                document.getElementById('delete-modal').classList.remove('flex');
            });
            
            document.getElementById('confirm-delete').addEventListener('click', confirmDeleteSelected);
        }
        
        function showLoading(show) {
            const loading = document.getElementById('loading-indicator');
            const grid = document.getElementById('images-grid');
            
            if (show) {
                loading.classList.remove('hidden');
                grid.classList.add('hidden');
            } else {
                loading.classList.add('hidden');
            }
        }
        
        function updateStatus(message) {
            document.getElementById('status-indicator').textContent = message;
        }
        
        function showError(message) {
            alert(message); // Replace with better error handling if needed
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Tag editing functions
        let currentEditingImage = null;

        function openTagEditor(imageId) {
            currentEditingImage = allImages.find(img => img.id === imageId);
            if (!currentEditingImage) return;

            // Populate the modal
            document.getElementById('tag-editor-image').src = currentEditingImage.image_url;
            document.getElementById('tag-editor-concept').textContent = `${currentEditingImage.concept} - ${currentEditingImage.subconcept}`;
            
            // Display current tags
            displayCurrentTags();
            
            // Clear new tag input
            document.getElementById('new-tag-input').value = '';
            
            // Show modal
            const modal = document.getElementById('tag-editor-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function displayCurrentTags() {
            const tagsContainer = document.getElementById('current-tags');
            const tags = currentEditingImage.tags || [];
            
            tagsContainer.innerHTML = '';
            
            if (tags.length === 0) {
                const emptyMessage = document.createElement('div');
                emptyMessage.className = 'text-gray-500 italic text-center py-2';
                emptyMessage.textContent = 'No tags assigned';
                tagsContainer.appendChild(emptyMessage);
                return;
            }
            
            tags.forEach((tag, index) => {
                const tagRow = document.createElement('div');
                tagRow.className = 'flex items-center gap-2 p-2 bg-white rounded border hover:bg-gray-50 tag-row';
                tagRow.innerHTML = `
                    <span class="text-sm font-medium text-gray-600 min-w-[60px]">Tag ${index}:</span>
                    <input type="text" id="tag-input-${index}" value="${escapeHtml(tag)}" 
                           class="flex-1 px-2 py-1 text-sm border rounded focus:outline-none focus:ring-1 focus:ring-blue-500 tag-input"
                           onchange="updateTagAtPosition(${index}, this.value)"
                           onkeypress="if(event.key==='Enter') this.blur()">
                    <button onclick="removeTagAtPosition(${index})" class="text-red-600 hover:text-red-800 p-1" title="Remove tag">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                `;
                tagsContainer.appendChild(tagRow);
            });
        }

        function addTag() {
            const input = document.getElementById('new-tag-input');
            const newTag = input.value.trim();
            
            if (!newTag) {
                showError('Please enter a tag name');
                return;
            }
            
            // Initialize tags array if it doesn't exist
            if (!currentEditingImage.tags) {
                currentEditingImage.tags = [];
            }
            
            // Check if tag already exists
            if (currentEditingImage.tags.includes(newTag)) {
                showError('This tag already exists');
                input.focus();
                return;
            }
            
            // Add tag to current image
            currentEditingImage.tags.push(newTag);
            
            // Update display
            displayCurrentTags();
            input.value = '';
            input.focus();
            
            updateStatus(`Added tag: "${newTag}"`);
        }
        
        function updateTagAtPosition(position, newValue) {
            const trimmedValue = newValue.trim();
            
            if (!trimmedValue) {
                showError('Tag cannot be empty');
                displayCurrentTags(); // Reset the display
                return;
            }
            
            if (!currentEditingImage.tags) {
                currentEditingImage.tags = [];
            }
            
            // Check if the new value already exists at a different position
            const existingIndex = currentEditingImage.tags.indexOf(trimmedValue);
            if (existingIndex !== -1 && existingIndex !== position) {
                showError('This tag already exists at another position');
                displayCurrentTags(); // Reset the display
                return;
            }
            
            // Update the tag at the specified position
            const oldValue = currentEditingImage.tags[position];
            currentEditingImage.tags[position] = trimmedValue;
            
            updateStatus(`Updated Tag ${position}: "${oldValue}" â†’ "${trimmedValue}"`);
        }
        
        function removeTagAtPosition(position) {
            if (!currentEditingImage.tags || position >= currentEditingImage.tags.length) {
                return;
            }
            
            const removedTag = currentEditingImage.tags[position];
            currentEditingImage.tags.splice(position, 1);
            
            displayCurrentTags();
            updateStatus(`Removed Tag ${position}: "${removedTag}"`);
        }

        function removeTag(tagToRemove) {
            if (!currentEditingImage.tags) return;
            
            const position = currentEditingImage.tags.indexOf(tagToRemove);
            if (position !== -1) {
                removeTagAtPosition(position);
            }
        }

        async function saveImageTags() {
            if (!currentEditingImage) return;
            
            try {
                updateStatus("Saving tags...");
                
                const response = await authenticatedFetch(`/api/imagecreator/images/${currentEditingImage.id}/tags`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(currentEditingImage.tags || [])
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to update tags: ${response.status}`);
                }
                
                // Update the image in allImages array
                const imageIndex = allImages.findIndex(img => img.id === currentEditingImage.id);
                if (imageIndex !== -1) {
                    allImages[imageIndex].tags = [...(currentEditingImage.tags || [])];
                }
                
                updateStatus("Tags updated successfully");
                closeTagEditor();
                
                // Refresh the display to show updated tags
                applyFiltersAndSort();
                
            } catch (error) {
                console.error("Error updating tags:", error);
                showError("Failed to update tags. Please try again.");
                updateStatus("Error updating tags");
            }
        }

        function closeTagEditor() {
            const modal = document.getElementById('tag-editor-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            currentEditingImage = null;
        }

        // Event listeners for tag editor modal
        document.getElementById('close-tag-editor').addEventListener('click', closeTagEditor);
        
        // Close modal when clicking outside
        document.getElementById('tag-editor-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeTagEditor();
            }
        });

        // Close modals with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                // Close tag editor if open
                const tagModal = document.getElementById('tag-editor-modal');
                if (!tagModal.classList.contains('hidden')) {
                    closeTagEditor();
                    return;
                }
                
                // Close preview modal if open
                const previewModal = document.getElementById('preview-modal');
                if (!previewModal.classList.contains('hidden')) {
                    previewModal.classList.add('hidden');
                    previewModal.classList.remove('flex');
                }
            }
        });
    </script>
</body>
</html>