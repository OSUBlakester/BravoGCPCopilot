<!DOCTYPE html>
<html>
<head>
    <title>Dynamic Grid Page</title>
    <title>Grid Page - v2.0</title> <!-- Will be updated by JavaScript -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="/static/splash-screen.css">
    <link rel="stylesheet" href="/static/mood-selection.css">
    <style>
        /* --- Basic Body Style --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px; /* Add padding around the "device" */
            /* Darker background to make the app container pop */
            background: #e2e8f0; 
            min-height: 100vh;
            box-sizing: border-box;
            display: flex;
            justify-content: center;
        }

        /* --- App Container (The "Phone/Tablet") --- */
        #app-container {
            width: 100%;
            max-width: 1200px; /* Tablet/Desktop limit */
            background-color: #f8fafc; /* Light blue-grey inside the app */
            border-radius: 40px; /* Large rounded corners */
            box-shadow: 
                0 25px 50px -12px rgba(0, 0, 0, 0.25), /* Deep shadow */
                0 0 0 1px rgba(0,0,0,0.05); /* Subtle border */
            overflow: hidden; /* Clip content to corners */
            min-height: calc(100vh - 40px); /* Full height minus body padding */
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* --- Admin Toolbar Styles --- */
        .admin-toolbar {
            background-color: transparent;
            padding: 0.5rem 1rem;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* --- Page Banner Styles --- */
        .page-banner {
            background-color: #002244; /* Solid navy blue like admin pages */
            color: #FB4F14; /* Orange text */
            padding: 0.5rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 50;
        }
        .page-banner h1 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
            text-align: left;
            color: #FB4F14; /* Orange text */
        }
        /* --- Original Styles --- */
        #gridContainer {
            display: grid;
            /* grid-template-columns will be set dynamically by JavaScript based on gridColumns setting */
            gap: 24px; /* Generous gap for "app icon" feel */
            padding: 24px;
            max-width: 1400px;
            margin: 0 auto;
            --button-font-size: 16px;
        }

        #gridContainer button {
            position: relative;
            padding: 12px;
            font-size: var(--button-font-size);
            font-weight: 600;
            cursor: pointer;
            
            /* Mobile Icon Style */
            background-color: #ffffff;
            color: #1e293b;
            border: 1px solid rgba(255,255,255,0.5); /* Subtle border */
            border-radius: 24px; /* "Squircle" look */
            
            /* Deep shadow for pop/depth */
            box-shadow: 
                0 10px 15px -3px rgba(0, 0, 0, 0.08),
                0 4px 6px -2px rgba(0, 0, 0, 0.04),
                inset 0 0 0 1px rgba(255,255,255,0.5);
                
            text-align: center;
            min-height: 100px; /* Square-ish aspect ratio preferred */
            aspect-ratio: 1 / 1; /* Try to keep it square if content allows */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); /* Bouncy spring transition */
            word-wrap: break-word;
            hyphens: auto;
            line-height: 1.2;
            overflow: hidden;
        }
        
        /* Ensure aspect ratio doesn't break layout on small screens or weird content */
        @supports not (aspect-ratio: 1 / 1) {
            #gridContainer button {
                height: 120px; 
            }
        }

         #gridContainer button:hover {
             transform: translateY(-6px) scale(1.02);
             box-shadow: 
                0 20px 25px -5px rgba(0, 0, 0, 0.1),
                0 10px 10px -5px rgba(0, 0, 0, 0.04);
             z-index: 10;
         }

         #gridContainer button:active {
            transform: scale(0.95);
            box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.05);
         }

        /* Sight Word Button Styling - Text only changes */
        .sight-word-button {
            font-size: 2.2em !important;
            font-weight: 900 !important;
            color: #dc2626 !important; /* Red text */
        }
        .sight-word-button:hover {
            color: #dc2626 !important;
        }

        /* Speech Bubble Tail - REMOVED */
        /* Removed speech bubble tail/triangle to clean up button appearance */
        #gridContainer button::before,
        #gridContainer button::after {
            display: none; /* Hide the speech bubble tail completely */
        }


        /* LLM button styling (if needed, keep separate) */
        .llm-button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #e0e0e0;
            border: 1px solid #ccc;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .llm-button:hover {
            background-color: #d0d0d0;
        }

        /* Text area styling */
        #chat-history-container, #question-container {
            width: 100%;
            margin-bottom: 8px;
            padding: 0 20px;
            box-sizing: border-box;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
        }

        .input-wrapper {
            position: relative;
            width: 100%;
            margin-top: 4px;
        }

        #speech-history, #question-display {
            width: 100%;
            box-sizing: border-box;
            padding: 6px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.75rem;
            background-color: #ffffff;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
            transition: border-color 0.2s, box-shadow 0.2s;
            display: block;
            resize: none; /* Fixed size based on rows */
        }
        
        #speech-history {
            padding-right: 24px; /* Space for clear button */
        }

        #question-display {
            margin-top: 4px;
        }
        
        #speech-history:focus, #question-display:focus {
            outline: none;
            border-color: #FB4F14;
            box-shadow: 0 0 0 2px rgba(251, 79, 20, 0.1);
        }

        /* Clear button positioning */
        #clear-history {
            position: absolute;
            right: 6px;
            top: 6px; /* Align with top padding */
            background-color: transparent;
            color: #94a3b8;
            border: none;
            font-size: 0.6rem;
            cursor: pointer;
            padding: 4px;
            border-radius: 50%;
            transition: all 0.2s;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
        }
        
        #clear-history:hover {
            background-color: #f1f5f9;
            color: #ef4444;
        }

        /* Label styling for speech history and question */
        #chat-history-container label, #question-container label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #1e293b; /* Darker gray */
            margin-left: 2px;
        }

        /* Spinner styles (Original border spinner - kept for reference if needed) */
        .spinner {
          border: 16px solid #f3f3f3;
          border-top: 16px solid #3498db;
          border-radius: 50%;
          width: 120px;
          height: 120px;
          animation: spin 2s linear infinite;
        }

        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }

        /* Style for loading indicator */
        #loading-indicator {
            /* display: none; */ /* Initial hiding is done via inline style */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6); /* Semi-transparent background */
            z-index: 1000; /* Ensure it's on top */

            /* --- CSS for Centering Content --- */
            display: flex; /* Use flexbox */
            flex-direction: column; /* Stack spinner and text vertically */
            align-items: center; /* Center horizontally */
            justify-content: center; /* Center vertically */
            /* --- End Centering --- */
        }

         #loading-indicator p { /* Style text below spinner */
             color: white;
             margin-top: 15px; /* More space */
             font-size: 1.2em; /* Slightly larger text */
         }

         /* Class for image spinner */
         .image-spinner {
            width: 120px;  /* Spinner size */
            height: 120px; /* Spinner size */
            animation: spin 1.5s linear infinite; /* Apply the spin animation */
         }

         .highlight-listening {
            /* Orange glow for highlighted state */
            box-shadow: 0 0 10px 4px #FB4F14; /* Orange glow */
            outline: none; /* Prevent default browser focus outline */
            transition: box-shadow 0.2s ease-in-out; /* Keep existing transition if any, or add */
        }

        .box {
            width: 100px;
            margin: 50px auto;
            border: 4px solid #002244;
            padding: 20px;
            text-align: center;
            font-weight: 900;
            color: #002244;
            font-family: arial;
            position: relative;
        }


        .sb1:before {
            content: "";
            width: 0px;
            height: 0px;
            position: absolute;
            border-left: 10px solid #002244;
            border-right: 10px solid transparent;
            border-top: 10px solid #002244;
            border-bottom: 10px solid transparent;
            left: 20px;
            bottom: -23px;
            }

            .sb1:after {
            content: "";
            width: 0px;
            height: 0px;
            position: absolute;
            border-left: 10px solid #fff;
            border-right: 10px solid transparent;
            border-top: 10px solid #fff;
            border-bottom: 10px solid transparent;
            left: 24px;
            bottom: -13px;
            }

    </style>
</head>
<body>
    <div id="app-container">


    <div class="page-banner">
        <h1 id="dynamic-page-title">Grid Page</h1> <!-- This H1 will be updated by JavaScript -->
        <div class="admin-toolbar">
            <!-- Always visible lock icon -->
            <button id="lock-icon" title="Admin Toolbar" class="h-10 w-10 flex items-center justify-center text-[#FB4F14] bg-white rounded-full transition-colors duration-200 text-base hover:bg-orange-100">
                <i class="fas fa-lock"></i>
            </button>
            <!-- Admin toolbar icons - initially hidden -->
            <div id="admin-icons" class="hidden flex items-center gap-0.4rem">
                <button id="lock-toolbar-button" title="Lock Admin Toolbar" class="h-10 w-10 flex items-center justify-center text-[#FB4F14] bg-white rounded-full transition-colors duration-200 text-base hover:bg-orange-100"><i class="fas fa-lock"></i></button>
                <span class="border-l border-white h-6 mx-1"></span> <!-- Separator -->
                <a href="admin_pages.html" title="Pages & Buttons" class="h-10 w-10 flex items-center justify-center text-[#FB4F14] bg-white rounded-full transition-colors duration-200 text-base hover:bg-orange-100"><i class="fas fa-th-large"></i></a>
                <a href="admin_settings.html" title="Global Settings" class="h-10 w-10 flex items-center justify-center text-[#FB4F14] bg-white rounded-full transition-colors duration-200 text-base hover:bg-orange-100"><i class="fas fa-cog"></i></a>
                <a href="user_current_admin.html" title="User Current Location" class="h-10 w-10 flex items-center justify-center text-[#FB4F14] bg-white rounded-full transition-colors duration-200 text-base hover:bg-orange-100"><i class="fas fa-map-marker-alt"></i></a>
                <a href="user_info_admin.html" title="User Info & Birthdays" class="h-10 w-10 flex items-center justify-center text-[#FB4F14] bg-white rounded-full transition-colors duration-200 text-base hover:bg-orange-100"><i class="fas fa-info-circle"></i></a>
                <a href="user_diary_admin.html" title="User Diary" class="h-10 w-10 flex items-center justify-center text-[#FB4F14] bg-white rounded-full transition-colors duration-200 text-base hover:bg-orange-100"><i class="fas fa-book-open"></i></a>
                <a href="audio_admin.html" title="Audio Devices" class="h-10 w-10 flex items-center justify-center text-[#FB4F14] bg-white rounded-full transition-colors duration-200 text-base hover:bg-orange-100"><i class="fas fa-volume-up"></i></a>
                <a href="favorites_admin.html" title="Favorites Topics" class="h-10 w-10 flex items-center justify-center text-[#FB4F14] bg-white rounded-full transition-colors duration-200 text-base hover:bg-orange-100"><i class="fas fa-star"></i></a>
                <a href="admin_audit_report.html" title="Activity Reports" class="h-10 w-10 flex items-center justify-center text-[#FB4F14] bg-white rounded-full transition-colors duration-200 text-base hover:bg-orange-100"><i class="fas fa-clipboard-list"></i></a>
                <span class="border-l border-white h-6 mx-1"></span> <!-- Separator -->
                <button id="switch-user-button" title="Switch User Profile" class="h-10 w-10 flex items-center justify-center text-[#FB4F14] bg-white rounded-full transition-colors duration-200 text-base hover:bg-orange-100"><i class="fas fa-users"></i></button>
                <button id="logout-button" title="Logout" class="h-10 w-10 flex items-center justify-center text-[#FB4F14] bg-white rounded-full transition-colors duration-200 text-base hover:bg-orange-100"><i class="fas fa-sign-out-alt"></i></button>
            </div>
            <!-- Help icon, always visible, to the right of admin toolbar -->
            <button id="help-icon" title="Help" aria-label="Help" class="h-10 w-10 flex items-center justify-center text-[#FB4F14] bg-white rounded-full ml-2 transition-colors duration-200 text-base hover:bg-orange-100 focus:outline-none focus:ring-2 focus:ring-orange-500">
                <i class="fas fa-question-circle"></i>
            </button>
        </div>
    <!-- Help Modal -->
    <div id="help-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-[90vw] h-[90vh] max-w-5xl max-h-[90vh] mx-2 relative flex flex-col">
            <button id="help-modal-close" class="absolute top-4 right-6 text-gray-500 hover:text-red-500 text-3xl font-bold focus:outline-none" aria-label="Close Help">&times;</button>
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-2xl font-bold text-gray-800">Help &amp; User Guide</h2>
                <a href="https://docs.google.com/document/d/e/2PACX-1vTartmB8DUzCYfFOkZtCaaZxD8TJMEMYThAEwM1v6_ccYgZOReamVGpG2XE0XdzJ5NTyw9aJLm5Yh6G/pub" target="_blank" rel="noopener" class="bg-green-100 text-green-700 px-4 py-2 rounded-md font-semibold hover:bg-green-200 transition">View Full Help</a>
            </div>
            <div id="help-modal-content" class="overflow-y-auto flex-1 px-0 py-0">
                <!-- Help content will be loaded here dynamically -->
                <div id="help-loading" class="text-center text-gray-400">Loading help...</div>
            </div>
            <div class="mt-4 text-center">
                <a href="#" id="open-contact-modal" class="inline-block text-green-700 font-semibold underline hover:text-green-900">Contact Support</a>
            </div>
    <!-- Contact Support Modal -->
    <div id="contact-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-[90vw] max-w-md mx-2 relative flex flex-col">
            <button id="contact-modal-close" class="absolute top-4 right-6 text-gray-500 hover:text-red-500 text-3xl font-bold focus:outline-none" aria-label="Close Contact">&times;</button>
            <h3 class="text-lg font-semibold mb-4">Contact Support</h3>
            <form id="contact-support-form" class="space-y-2" method="POST" action="https://formspree.io/f/myzpzero">
                <input type="text" id="support-name" name="name" placeholder="Your Name" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                <input type="email" id="support-email" name="email" placeholder="Your Email" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                <textarea id="support-message" name="message" placeholder="How can we help you?" class="w-full px-3 py-2 border border-gray-300 rounded-md" rows="3" required></textarea>
                <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-md hover:bg-green-700">Send to Support</button>
            </form>
            <div id="support-success" class="hidden text-green-600 mt-2">Thank you! Your message has been sent.</div>
            <div id="support-error" class="hidden text-red-600 mt-2">There was an error sending your message. Please try again or email admin@talkwithbravo.com.</div>
        </div>
    </div>
        </div>
    </div>
    </div>

    <!-- PIN Modal -->
    <div id="pin-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Enter Admin PIN</h3>
            <input type="text" id="pin-input" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Enter PIN" maxlength="10">
            <div class="flex justify-end space-x-3 mt-4">
                <button id="pin-cancel" class="px-4 py-2 text-gray-600 bg-gray-200 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-500">Cancel</button>
                <button id="pin-submit" class="px-4 py-2 text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">Submit</button>
            </div>
            <p id="pin-error" class="text-red-500 text-sm mt-2 hidden">Incorrect PIN. Please try again.</p>
        </div>
    </div>

    <div id="chat-history-container">
        <label for="speech-history">Speech History:</label>
        <div class="input-wrapper">
            <textarea id="speech-history" readonly rows="3"></textarea>
            <button id="clear-history" title="Clear History">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <div id="question-container">
        <label for="question-display">Question:</label>
        <textarea id="question-display" readonly rows="1"></textarea>
    </div>

    <div id="gridContainer">
        </div>

    <div id="loading-indicator" style="display: none;">
            <img src="/static/images/speech_bubble_spinner.png" alt="Loading..."
                 class="image-spinner">
             <p>Loading...</p>
    </div>
    </div> <!-- End of app-container -->


    <script src="/static/splash-screen.js"></script>
    <script src="/static/avatar-selector.js"></script>
    <script src="/static/mood-selection.js"></script>
    <script src="/static/sight-word-service.js"></script>
    <script src="/static/gridpage.js"></script>
    <script>
    // --- Help Modal Logic ---
    const helpIcon = document.getElementById('help-icon');
    const helpModal = document.getElementById('help-modal');
    const helpModalClose = document.getElementById('help-modal-close');
    const helpModalContent = document.getElementById('help-modal-content');
    const helpLoading = document.getElementById('help-loading');
    const contactForm = document.getElementById('contact-support-form');
    const supportSuccess = document.getElementById('support-success');
    const supportError = document.getElementById('support-error');
    const openContactModal = document.getElementById('open-contact-modal');
    const contactModal = document.getElementById('contact-modal');
    const contactModalClose = document.getElementById('contact-modal-close');

    // Google Doc HTML export link
    const HELP_DOC_URL = 'https://docs.google.com/document/d/e/2PACX-1vTartmB8DUzCYfFOkZtCaaZxD8TJMEMYThAEwM1v6_ccYgZOReamVGpG2XE0XdzJ5NTyw9aJLm5Yh6G/pub';

    async function loadDynamicHelpContent() {
        try {
            helpLoading.style.display = '';
            helpModalContent.innerHTML = '';
            
            // Get current page from URL
            const urlParams = new URLSearchParams(window.location.search);
            const currentPage = urlParams.get('page') || 'home';
            
            // Load page-specific help first
            let pageHelpResponse, generalHelpResponse;
            
            try {
                pageHelpResponse = await fetch(`/api/help/content?page=${currentPage}`);
            } catch (error) {
                console.warn('Failed to load page-specific help:', error);
            }
            
            try {
                generalHelpResponse = await fetch('/api/help/content');
            } catch (error) {
                console.warn('Failed to load general help:', error);
            }
            
            let helpContent = '';
            
            // Display page-specific help first
            if (pageHelpResponse && pageHelpResponse.ok) {
                const pageHelpData = await pageHelpResponse.json();
                if (pageHelpData.content && pageHelpData.content.length > 0) {
                    helpContent += `
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold text-green-700 mb-3 border-b border-green-200 pb-2">
                                <i class="fas fa-map-marker-alt mr-2"></i>Help for ${currentPage.charAt(0).toUpperCase() + currentPage.slice(1)} Page
                            </h3>
                            <div class="space-y-4">
                    `;
                    
                    pageHelpData.content.forEach(item => {
                        helpContent += `
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                <h4 class="font-medium text-gray-800 mb-2">${escapeHtml(item.title)}</h4>
                                <div class="text-gray-700">${item.content}</div>
                            </div>
                        `;
                    });
                    
                    helpContent += `
                            </div>
                        </div>
                    `;
                }
            }
            
            // Display general help
            if (generalHelpResponse && generalHelpResponse.ok) {
                const generalHelpData = await generalHelpResponse.json();
                if (generalHelpData.content && generalHelpData.content.length > 0) {
                    helpContent += `
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold text-blue-700 mb-3 border-b border-blue-200 pb-2">
                                <i class="fas fa-info-circle mr-2"></i>General Help
                            </h3>
                            <div class="space-y-4">
                    `;
                    
                    generalHelpData.content.forEach(item => {
                        helpContent += `
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <h4 class="font-medium text-gray-800 mb-2">${escapeHtml(item.title)}</h4>
                                <div class="text-gray-700">${item.content}</div>
                            </div>
                        `;
                    });
                    
                    helpContent += `
                            </div>
                        </div>
                    `;
                }
            }
            
            // If no dynamic content is available, show fallback message
            if (!helpContent.trim()) {
                helpContent = `
                    <div class="text-center py-8">
                        <i class="fas fa-info-circle text-gray-400 text-4xl mb-4"></i>
                        <p class="text-gray-600 mb-4">No help content is currently available.</p>
                        <p class="text-gray-500 text-sm">Contact your administrator to add help content.</p>
                    </div>
                `;
            }
            
            helpModalContent.innerHTML = helpContent;
            helpLoading.style.display = 'none';
            
        } catch (error) {
            console.error('Error loading help content:', error);
            // Fallback to original static help
            loadStaticHelpContent();
        }
    }

    async function loadStaticHelpContent() {
        try {
            // Load the local HTML export for the help guide as fallback
            const response = await fetch('/static/Guide with talkwithbravo.com/Guide with talkwithbravo.com.html');
            const html = await response.text();
            
            // Parse and extract the main guide content
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            // Get the first <div> inside <body>
            const body = tempDiv.querySelector('body');
            let guideDiv = body ? body.querySelector('div') : tempDiv.querySelector('div');
            
            if (guideDiv) {
                // Fix image and video src paths to be absolute paths
                guideDiv.querySelectorAll('img').forEach(img => {
                    let src = img.getAttribute('src');
                    if (src && !src.startsWith('http') && !src.startsWith('/static/Guide with talkwithbravo.com/')) {
                        img.setAttribute('src', '/static/Guide with talkwithbravo.com/' + src);
                    }
                });
                guideDiv.querySelectorAll('video source').forEach(source => {
                    let src = source.getAttribute('src');
                    if (src && !src.startsWith('http') && !src.startsWith('/static/Guide with talkwithbravo.com/')) {
                        source.setAttribute('src', '/static/Guide with talkwithbravo.com/' + src);
                    }
                });

                // Build navigation bar for steps
                const steps = Array.from(guideDiv.querySelectorAll('div > h3'));
                let navHtml = '<nav class="help-nav" style="min-width:180px;max-width:220px;padding:1rem 0 1rem 1rem;border-right:1px solid #eee;">';
                navHtml += '<h3 class="font-bold mb-2">Jump to Step</h3><ul style="list-style:none;padding:0;margin:0;">';
                steps.forEach((h3, idx) => {
                    const stepText = h3.textContent.trim();
                    const anchorId = 'help-step-' + (idx+1);
                    h3.setAttribute('id', anchorId);
                    navHtml += `<li style="margin-bottom:8px;"><a href="#${anchorId}" class="text-green-700 hover:text-green-900 underline">${stepText}</a></li>`;
                });
                navHtml += '</ul></nav>';

                // Layout: left nav, right content
                helpModalContent.innerHTML = `<div style="display:flex;height:100%;"><div>${navHtml}</div><div style="flex:1;overflow-y:auto;padding-left:2rem;">${guideDiv.outerHTML}</div></div>`;
            } else {
                helpModalContent.innerHTML = '<div class="text-red-600">Could not load help content. Please try again later.</div>';
            }
            helpLoading.style.display = 'none';
        } catch (error) {
            console.error('Error loading static help content:', error);
            helpModalContent.innerHTML = '<div class="text-red-600">Could not load help content. Please try again later.</div>';
            helpLoading.style.display = 'none';
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function openHelpModal() {
        helpModal.classList.remove('hidden');
        loadDynamicHelpContent();
    }
    // --- Contact Modal Logic ---
    function openContactSupportModal() {
        contactModal.classList.remove('hidden');
        if (contactForm) contactForm.reset();
        if (supportSuccess) supportSuccess.classList.add('hidden');
        if (supportError) supportError.classList.add('hidden');
    }
    function closeContactSupportModal() {
        contactModal.classList.add('hidden');
    }
    if (openContactModal) openContactModal.addEventListener('click', function(e) {
        e.preventDefault();
        openContactSupportModal();
    });
    if (contactModalClose) contactModalClose.addEventListener('click', closeContactSupportModal);
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !contactModal.classList.contains('hidden')) closeContactSupportModal();
    });
    contactModal.addEventListener('mousedown', (e) => {
        if (e.target === contactModal) closeContactSupportModal();
    });

    function closeHelpModal() {
        helpModal.classList.add('hidden');
    }

    if (helpIcon) helpIcon.addEventListener('click', openHelpModal);
    if (helpModalClose) helpModalClose.addEventListener('click', closeHelpModal);
    // Close modal on Escape or click outside
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !helpModal.classList.contains('hidden')) closeHelpModal();
    });
    helpModal.addEventListener('mousedown', (e) => {
        if (e.target === helpModal) closeHelpModal();
    });

    // --- Contact Support Form Logic (Formspree AJAX) ---
    if (contactForm) {
        contactForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(contactForm);
            fetch('https://formspree.io/f/myzpzero', {
                method: 'POST',
                headers: {
                    'Accept': 'application/json'
                },
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    if (supportSuccess) supportSuccess.classList.remove('hidden');
                    if (supportError) supportError.classList.add('hidden');
                    contactForm.reset();
                } else {
                    return response.json().then(data => { throw data; });
                }
            })
            .catch(() => {
                if (supportSuccess) supportSuccess.classList.add('hidden');
                if (supportError) supportError.classList.remove('hidden');
            });
        });
    }
    </script>
    
</body>
</html>
