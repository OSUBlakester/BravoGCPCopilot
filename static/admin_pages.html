<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Manage Pages</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="/static/interactive-guide.js?v=20250901-fix3" defer></script>
    <script src="/static/admin-pages-guide-fixed.js?v=20250901-fix5" defer></script>
    <script src="/static/admin-pages-comprehensive-guide.js?v=20250901-fix5" defer></script>
    <script src="/static/admin_pages.js?v=20251021-mp3-feature" defer></script>
  <style>
    /* Custom base styles */
    body {
      font-family: 'Inter', sans-serif;
    }
    /* Style for the button grid cells */
    #buttonGrid {
      display: grid;
      grid-template-columns: repeat(10, minmax(120px, 1fr));
      gap: 8px;
      width: 100%;
      border: 1px solid #ccc;
      margin-top: 1rem;
      margin-bottom: 1rem;
      background-color: #f0f0f0;
      overflow-x: auto;
      padding: 8px;
    }

    .visual-button {
      border: 2px solid #d1d5db;
      border-radius: 8px;
      padding: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: white;
      min-height: 80px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.875rem;
      font-weight: 500;
      text-align: center;
      word-wrap: break-word;
      position: relative;
    }

    .visual-button:hover {
      border-color: #3b82f6;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transform: translateY(-1px);
    }

    .visual-button.undefined {
      background-color: #f9fafb;
      color: #6b7280;
      border-style: dashed;
      font-style: italic;
    }

    .visual-button.has-content {
      background-color: #ffffff;
      color: #1f2937;
      border-color: #059669;
    }

    .visual-button.has-ai {
      background: linear-gradient(135deg, #ddd6fe 0%, #e0e7ff 100%);
      border-color: #7c3aed;
    }

    .visual-button.has-navigation {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-color: #d97706;
    }

    .visual-button.dragging {
      opacity: 0.5;
      transform: rotate(5deg);
    }

    .visual-button.drop-target {
      border-color: #ef4444;
      border-width: 3px;
      background-color: #fef2f2;
    }

    .button-indicator {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      font-size: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .indicator-ai {
      background-color: #7c3aed;
      color: white;
    }

    .indicator-nav {
      background-color: #d97706;
      color: white;
    }

    .indicator-speech {
      background-color: #059669;
      color: white;
    }

    /* Wizard styles */
    .wizard-step {
      min-height: 200px;
    }

    /* Modal styles */
    .modal {
      backdrop-filter: blur(4px);
    }

    .gridCell textarea {
      min-height: 40px;
      resize: vertical; /* Allow vertical resize */
      text-align: left; /* Align text left */
      padding: 4px;
    }
    /* Hamburger Menu Styles */
    .hamburger-menu {
        position: relative;
        display: inline-block;
    }
    #hamburger-btn {
        background-color: #4A5568; /* Tailwind gray-700 or similar */
        color: white;
        padding: 8px 12px; /* Adjust for a good size */
        font-size: 20px; /* Hamburger icon size */
        border: none;
        cursor: pointer;
        border-radius: 5px;
        line-height: 1; /* Ensure icon is centered vertically */
    }
    #hamburger-btn:hover {
        background-color: #2D3748; /* Darker shade for hover */
    }
    .dropdown-content {
        display: none; /* Hidden by default */
        position: absolute;
        background-color: #ffffff; /* White background for dropdown */
        min-width: 260px; /* Adjust as needed */
        box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
        z-index: 1000; /* Ensure it's on top */
        left: 0; /* Align to the left of the button */
        border-radius: 5px;
        border: 1px solid #ddd; /* Light border for the dropdown */
    }
    .dropdown-content a {
        color: #333; /* Dark text for links */
        padding: 10px 15px;
        text-decoration: none;
        display: block;
        font-size: 14px; /* Standard font size for menu items */
    }
    .dropdown-content a:hover {
        background-color: #f0f0f0; /* Hover effect for links */
    }
    .dropdown-content hr {
        border: 0;
        height: 1px;
        background-color: #e0e0e0; /* Separator color */
        margin: 5px 0;
    }
  </style>
</head>
<body>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <script>
        // --- DYNAMIC AUTHENTICATION & CONFIGURATION CONTEXT ---
        (async () => {
            // 1. Fetch Firebase config dynamically
            let firebaseConfig;
            try {
                const response = await fetch('/api/frontend-config');
                if (!response.ok) throw new Error(`Server error (${response.status})`);
                const configData = await response.json();
                firebaseConfig = configData.firebase_config || configData;
                if (!firebaseConfig || !firebaseConfig.apiKey) throw new Error('Invalid config from server.');
            } catch (error) {
                console.error('Fatal: Could not load application configuration.', error);
                document.body.innerHTML = `<div style="padding: 2rem; text-align: center; color: red; font-family: sans-serif;">Failed to load application configuration. Please refresh the page.</div>`;
                return;
            }

            // 2. Initialize Firebase
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            console.log(`Firebase initialized for project: ${firebaseConfig.projectId}`);

            // 3. Check for logged-in user and set up context using onAuthStateChanged
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    const currentAacUserId = sessionStorage.getItem("currentAacUserId");
                    const tokenFromUser = await user.getIdToken();
                    sessionStorage.setItem("firebaseIdToken", tokenFromUser);

                    if (!currentAacUserId) {
                        console.warn("No AAC User ID found in session. Redirecting to auth page for user selection.");
                        window.location.href = 'auth.html';
                        return;
                    }

                    // 6. Define and expose a global authenticatedFetch function
                    window.authenticatedFetch = async (url, options = {}) => {
                        console.log(`authenticatedFetch called: ${options.method || 'GET'} ${url}`);
                        console.log('Request options:', options);
                        
                        const headers = options.headers || {};
                        headers['Authorization'] = `Bearer ${tokenFromUser}`;
                        headers['X-User-ID'] = currentAacUserId;
                        
                        // Handle both admin and account owner scenarios
                        const adminTargetAccountId = sessionStorage.getItem('adminTargetAccountId');
                        const adminAccessContext = sessionStorage.getItem('adminAccessContext');
                        
                        console.log(`DEBUG: Session storage items:`, {
                            currentAacUserId: sessionStorage.getItem('currentAacUserId'),
                            adminTargetAccountId: sessionStorage.getItem('adminTargetAccountId'),
                            adminSelectedAccountId: sessionStorage.getItem('adminSelectedAccountId'),
                            adminAccessContext: sessionStorage.getItem('adminAccessContext'),
                            firebaseIdToken: sessionStorage.getItem('firebaseIdToken') ? 'present' : 'missing'
                        });
                        
                        if (adminTargetAccountId) {
                            // Admin managing another account
                            headers['X-Admin-Target-Account'] = adminTargetAccountId;
                            console.log(`Admin mode: Setting admin target account header: ${adminTargetAccountId}`);
                        } else if (adminAccessContext === 'true') {
                            // Admin context but no target account (shouldn't happen, but log it)
                            console.warn('Admin access context set but no adminTargetAccountId found');
                        } else {
                            // Account owner managing their own account
                            console.log(`Account owner mode: User ${currentAacUserId} managing their own account`);
                        }
                        
                        options.headers = headers;
                        console.log('About to call fetch with:', url, options);
                        
                        try {
                            const response = await fetch(url, options);
                            console.log(`Fetch completed: ${response.status} ${response.statusText}`);
                            return response;
                        } catch (error) {
                            console.error('Fetch error:', error);
                            throw error;
                        }
                        if (response.status === 401 || response.status === 403) {
                            console.warn(`Auth failed (${response.status}). Redirecting to login.`);
                            sessionStorage.clear();
                            window.location.href = 'auth.html';
                            throw new Error("Session expired.");
                        }
                        return response;
                    };

                    // 7. Expose context and notify deferred scripts that the context is ready
                    window.currentAacUserId = currentAacUserId;
                    window.firebaseIdToken = tokenFromUser;
                    window.adminContextInitializedByInlineScript = true;
                    
                    // 8. Global function to update page title with profile name
                    window.updatePageTitleWithProfile = async (baseTitle) => {
                        try {
                            const response = await window.authenticatedFetch('/api/account/users');
                            if (!response.ok) return;
                            
                            const profiles = await response.json();
                            const currentProfile = profiles.find(profile => profile.aac_user_id === currentAacUserId);
                            
                            if (currentProfile && currentProfile.display_name) {
                                const titleElement = document.getElementById('dynamic-page-title');
                                if (titleElement) {
                                    titleElement.textContent = `${baseTitle} - ${currentProfile.display_name}`;
                                }
                            }
                        } catch (error) {
                            console.error('Error updating page title with profile:', error);
                        }
                    };
                    
                    document.dispatchEvent(new Event('adminUserContextReady'));
                    console.log(`Admin context ready for AAC User ID: ${currentAacUserId}`);

                } else {
                    console.log("No Firebase user session found. Redirecting to auth.html.");
                    sessionStorage.clear();
                    window.location.href = 'auth.html';
                }
            });
        })();
    </script>


    <div class="page-banner">
        <div class="page-banner flex items-center justify-between bg-[#002244] text-[#FB4F14] px-4 py-2 shadow">
            <div class="flex items-center gap-2">
                <a href="gridpage.html?page=home" class="h-10 w-10 flex items-center justify-center text-[#FB4F14] bg-white rounded-full transition-colors duration-200 text-base hover:bg-orange-100 focus:outline-none focus:ring-2 focus:ring-orange-500" title="Home">
                    <i class="fas fa-home"></i>
                </a>
                <h1 id="dynamic-page-title" class="ml-2 text-xl font-semibold">Page &amp; Button Administration</h1>
            </div>
            <div class="admin-toolbar flex items-center gap-2">
                <a href="admin_pages.html" title="Pages &amp; Buttons" class="h-10 w-10 flex items-center justify-center text-[#FB4F14] bg-white rounded-full transition-colors duration-200 text-base hover:bg-orange-100"><i class="fas fa-th-large"></i></a>
                <a href="admin_settings.html" title="Global Settings" class="h-10 w-10 flex items-center justify-center text-[#FB4F14] bg-white rounded-full transition-colors duration-200 text-base hover:bg-orange-100"><i class="fas fa-cog"></i></a>
                <a href="user_current_admin.html" title="User Current Location" class="h-10 w-10 flex items-center justify-center text-[#FB4F14] bg-white rounded-full transition-colors duration-200 text-base hover:bg-orange-100"><i class="fas fa-map-marker-alt"></i></a>
                <a href="user_info_admin.html" title="User Info &amp; Birthdays" class="h-10 w-10 flex items-center justify-center text-[#FB4F14] bg-white rounded-full transition-colors duration-200 text-base hover:bg-orange-100"><i class="fas fa-info-circle"></i></a>
                <a href="user_diary_admin.html" title="User Diary" class="h-10 w-10 flex items-center justify-center text-[#FB4F14] bg-white rounded-full transition-colors duration-200 text-base hover:bg-orange-100"><i class="fas fa-book-open"></i></a>
                <a href="audio_admin.html" title="Audio Devices" class="h-10 w-10 flex items-center justify-center text-[#FB4F14] bg-white rounded-full transition-colors duration-200 text-base hover:bg-orange-100"><i class="fas fa-volume-up"></i></a>
                <a href="favorites_admin.html" title="Event Sources" class="h-10 w-10 flex items-center justify-center text-[#FB4F14] bg-white rounded-full transition-colors duration-200 text-base hover:bg-orange-100"><i class="fas fa-star"></i></a>
                <a href="admin_audit_report.html" title="Activity Reports" class="h-10 w-10 flex items-center justify-center text-[#FB4F14] bg-white rounded-full transition-colors duration-200 text-base hover:bg-orange-100"><i class="fas fa-clipboard-list"></i></a>
                <a href="missing_images.html" title="Missing Images Log" class="h-10 w-10 flex items-center justify-center text-[#FB4F14] bg-white rounded-full transition-colors duration-200 text-base hover:bg-orange-100"><i class="fas fa-image"></i></a>
                <span class="border-l border-gray-300 h-6 mx-1"></span>
                <button id="switch-user-button" title="Switch User Profile" class="h-10 w-10 flex items-center justify-center text-[#FB4F14] bg-white rounded-full transition-colors duration-200 text-base hover:bg-orange-100"><i class="fas fa-users"></i></button>
                <button id="logout-button" title="Logout" class="h-10 w-10 flex items-center justify-center text-[#FB4F14] bg-white rounded-full transition-colors duration-200 text-base hover:bg-orange-100"><i class="fas fa-sign-out-alt"></i></button>
                <button id="help-icon" title="Help" aria-label="Help" class="h-10 w-10 flex items-center justify-center text-[#FB4F14] bg-white rounded-full ml-2 transition-colors duration-200 text-base hover:bg-orange-100 focus:outline-none focus:ring-2 focus:ring-orange-500">
                    <i class="fas fa-question-circle"></i>
                </button>
            </div>
        </div>
    <!-- Help Modal -->
    <div id="help-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-[90vw] h-[90vh] max-w-5xl max-h-[90vh] mx-2 relative flex flex-col">
            <button id="help-modal-close" class="absolute top-4 right-6 text-gray-500 hover:text-red-500 text-3xl font-bold focus:outline-none" aria-label="Close Help">&times;</button>
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-2xl font-bold text-gray-800">Help &amp; User Guide</h2>
                <a href="https://docs.google.com/document/d/e/2PACX-1vTartmB8DUzCYfFOkZtCaaZxD8TJMEMYThAEwM1v6_ccYgZOReamVGpG2XE0XdzJ5NTyw9aJLm5Yh6G/pub" target="_blank" rel="noopener" class="bg-green-100 text-green-700 px-4 py-2 rounded-md font-semibold hover:bg-green-200 transition">View Full Help</a>
            </div>
            <div id="help-modal-content" class="overflow-y-auto flex-1 px-0 py-0">
                <!-- Help content will be loaded here dynamically -->
                <div id="help-loading" class="text-center text-gray-400">Loading help...</div>
            </div>
            <div class="mt-4 text-center">
                <a href="#" id="open-contact-modal" class="inline-block text-green-700 font-semibold underline hover:text-green-900">Contact Support</a>
            </div>
    <!-- Contact Support Modal -->
    <div id="contact-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-[90vw] max-w-md mx-2 relative flex flex-col">
            <button id="contact-modal-close" class="absolute top-4 right-6 text-gray-500 hover:text-red-500 text-3xl font-bold focus:outline-none" aria-label="Close Contact">&times;</button>
            <h3 class="text-lg font-semibold mb-4">Contact Support</h3>
            <form id="contact-support-form" class="space-y-2" method="POST" action="https://formspree.io/f/myzpzero">
                <input type="text" id="support-name" name="name" placeholder="Your Name" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                <input type="email" id="support-email" name="email" placeholder="Your Email" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                <textarea id="support-message" name="message" placeholder="How can we help you?" class="w-full px-3 py-2 border border-gray-300 rounded-md" rows="3" required></textarea>
                <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-md hover:bg-green-700">Send to Support</button>
            </form>
            <div id="support-success" class="hidden text-green-600 mt-2">Thank you! Your message has been sent.</div>
            <div id="support-error" class="hidden text-red-600 mt-2">There was an error sending your message. Please try again or email admin@talkwithbravo.com.</div>
        </div>
    </div>
        </div>
    </div>
    </div>

    <script>
    // --- Help Modal Logic ---
    const helpIcon = document.getElementById('help-icon');
    const helpModal = document.getElementById('help-modal');
    const helpModalClose = document.getElementById('help-modal-close');
    const helpModalContent = document.getElementById('help-modal-content');
    const helpLoading = document.getElementById('help-loading');

    function openHelpModal() {
        console.log('üîç DEBUG: openHelpModal called');
        console.log('üîç DEBUG: window.guideInstance exists?', !!window.guideInstance);
        console.log('üîç DEBUG: window.guideInstance type:', typeof window.guideInstance);
        if (window.guideInstance) {
            console.log('üîç DEBUG: guideInstance methods:', Object.getOwnPropertyNames(Object.getPrototypeOf(window.guideInstance)));
            console.log('üîç DEBUG: startComprehensiveGuide exists?', typeof window.guideInstance.startComprehensiveGuide);
            console.log('üîç DEBUG: smartHelp exists?', !!window.guideInstance.smartHelp);
            console.log('üîç DEBUG: multimedia exists?', !!window.guideInstance.multimedia);
        }
        
        // Try to use comprehensive guide first
        if (window.guideInstance && typeof window.guideInstance.startComprehensiveGuide === 'function') {
            console.log('üöÄ Attempting to start comprehensive guide...');
            // Check if the guide is fully initialized
            if (window.guideInstance.smartHelp && window.guideInstance.multimedia) {
                console.log('‚úÖ Guide fully initialized, starting comprehensive guide');
                window.guideInstance.startComprehensiveGuide();
                return;
            } else {
                // Wait a bit for initialization to complete
                console.log('‚è≥ Waiting for comprehensive guide to initialize...');
                setTimeout(() => {
                    if (window.guideInstance && window.guideInstance.smartHelp && window.guideInstance.multimedia) {
                        console.log('‚úÖ Guide initialized after wait, starting comprehensive guide');
                        window.guideInstance.startComprehensiveGuide();
                    } else {
                        console.warn('‚ùå Comprehensive guide still not ready after wait, falling back to old help modal');
                        showOldHelpModal();
                    }
                }, 500);
                return;
            }
        } else {
            // Fallback to old help modal if comprehensive guide is not available
            console.warn('‚ùå Comprehensive guide not available, falling back to old help modal');
            console.log('üîç DEBUG: Reason - guideInstance exists?', !!window.guideInstance, 'startComprehensiveGuide function?', !!(window.guideInstance && typeof window.guideInstance.startComprehensiveGuide === 'function'));
            showOldHelpModal();
        }
    }
    
    function showOldHelpModal() {
        console.log('üìã Showing old help modal as fallback');
        helpModal.classList.remove('hidden');
        helpLoading.style.display = '';
        // Load static help for this page (customize as needed)
        helpModalContent.innerHTML = `<div class='p-4'><h3 class='text-lg font-bold mb-2'>Admin Pages Help</h3><p>This page allows you to manage the grid of pages and buttons. Select a page, edit its details, and configure the button grid. For more help, contact support.</p></div>`;
    }
    
    function closeHelpModal() {
        helpModal.classList.add('hidden');
    }
    if (helpIcon) helpIcon.addEventListener('click', openHelpModal);
    if (helpModalClose) helpModalClose.addEventListener('click', closeHelpModal);
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !helpModal.classList.contains('hidden')) closeHelpModal();
    });
    helpModal.addEventListener('mousedown', (e) => {
        if (e.target === helpModal) closeHelpModal();
    });
    </script>

    <!-- --- Page Management Form --- -->
    <main class="container mx-auto p-4 mt-8 bg-white rounded-lg shadow-md text-gray-800">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold">Manage Pages & Buttons</h2>
            <button id="openMigrationBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors">
                <i class="fas fa-exchange-alt"></i>
                Migrate User Data
            </button>
        </div>

        <div class="mb-6 flex items-center space-x-4">
            <div class="flex-1">
                <label for="selectPage" class="block text-sm font-medium text-gray-700">Select Page:</label>
                <select id="selectPage" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></select>
            </div>
            <div class="flex-shrink-0 pt-6">
                <button type="button" id="createNewPageBtn" class="px-4 py-2 bg-green-600 text-white rounded-md shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                    <i class="fas fa-plus mr-2"></i>Create New Page
                </button>
            </div>
        </div>

        <form id="pageForm" class="mb-6 p-4 border rounded-md bg-gray-50">
            <h3 class="text-xl font-semibold mb-3">Page Details</h3>
            <div class="mb-4">
                <label for="newPageDisplayName" class="block text-sm font-medium text-gray-700">Display Name (for Menu/Banner):</label>
                <input type="text" id="newPageDisplayName" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="e.g., Daily Greetings, What to Eat">
                <p class="mt-1 text-sm text-gray-500">Update the display name for the currently selected page</p>
            </div>
            <div class="flex space-x-3">
                <button type="button" id="updatePageBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Update Page</button>
                <button type="button" id="deletePage" class="px-4 py-2 bg-red-600 text-white rounded-md shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">Delete Page</button>
                <button type="button" id="revertPageBtn" class="px-4 py-2 bg-gray-500 text-white rounded-md shadow-sm hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">Revert Changes</button>
            </div>
        </form>

        <h3 class="text-xl font-semibold mb-3">Page Buttons (10x10 Grid)</h3>
        <p class="text-gray-600 mb-4">Click on any button to edit its configuration. Drag and drop to rearrange buttons.</p>
        
        <!-- Button Grid Controls -->
        <div class="flex space-x-3 mb-4">
            <button type="button" id="saveButtonsBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Save Button Changes</button>
            <button type="button" id="helpWizardBtn" class="px-4 py-2 bg-green-600 text-white rounded-md shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                <i class="fas fa-question-circle mr-2"></i>New Button Wizard
            </button>
        </div>
        
        <div id="buttonGrid" class="grid grid-cols-10 auto-rows-auto gap-2 p-2 border border-gray-300 rounded-md bg-gray-100 overflow-x-auto min-h-[500px]">
            <!-- Visual buttons will be rendered here by JavaScript -->
        </div>
    </main>

    <!-- Button Editor Modal -->
    <div id="buttonEditorModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-900">Edit Button</h3>
                <button id="closeButtonEditor" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Left Column: Button Configuration -->
                <div>
                    <div class="mb-4">
                        <label for="buttonText" class="block text-sm font-medium text-gray-700 mb-2">Button Text</label>
                        <input type="text" id="buttonText" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter button text">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Button Image (Optional)</label>
                        <div class="flex items-center space-x-3">
                            <div id="assignedImagePreview" class="w-16 h-16 border-2 border-dashed border-gray-300 rounded-md flex items-center justify-center bg-gray-50 hidden">
                                <img id="assignedImageThumb" class="w-full h-full object-cover rounded-md" alt="Selected image">
                            </div>
                            <div class="flex-1">
                                <button type="button" id="browseImagesBtn" class="w-full px-3 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500">
                                    <i class="fas fa-image mr-2"></i>Browse Images
                                </button>
                                <button type="button" id="clearImageBtn" class="w-full px-3 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 mt-2 hidden">
                                    <i class="fas fa-times mr-2"></i>Clear Image
                                </button>
                            </div>
                        </div>
                        <input type="hidden" id="assignedImageUrl" value="">
                        <p class="text-xs text-gray-500 mt-1">Assign a specific image from BravoImages. If not assigned, image will be searched based on button text.</p>
                    </div>
                    
                    <div class="mb-4">
                        <label for="speechPhrase" class="block text-sm font-medium text-gray-700 mb-2">Speech Phrase (Optional)</label>
                        <input type="text" id="speechPhrase" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="What to say before action">
                    </div>
                    
                    <div class="mb-4">
                        <label for="customAudioFile" class="block text-sm font-medium text-gray-700 mb-2">Custom Audio File (Optional)</label>
                        <input type="file" id="customAudioFile" accept="audio/*" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                        <input type="hidden" id="customAudioFileUrl" value="">
                        <p class="text-xs text-gray-500 mt-1">Upload MP3, WAV, or M4A file to play after speech phrase. Max 10MB.</p>
                        <div id="audioUploadStatus" class="text-xs mt-1 hidden"></div>
                    </div>
                    
                    <div class="mb-4">
                        <label for="targetPage" class="block text-sm font-medium text-gray-700 mb-2">Target Page (Optional)</label>
                        <select id="targetPage" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">No page navigation</option>
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label class="flex items-center">
                            <input type="checkbox" id="temporaryNavigation" class="mr-2">
                            <span class="text-sm font-medium text-gray-700">Temporary Navigation</span>
                        </label>
                        <p class="text-xs text-gray-500 mt-1 ml-6">When checked, any button click on the target page returns to this page</p>
                    </div>
                    
                    <div class="mb-4">
                        <label for="llmQuery" class="block text-sm font-medium text-gray-700 mb-2">AI Query (Optional)</label>
                        <textarea id="llmQuery" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Describe what AI should generate (will use #LLMOptions for count)"></textarea>
                    </div>
                    
                    <div class="mb-4">
                        <label class="flex items-center">
                            <input type="checkbox" id="buttonHidden" class="mr-2">
                            <span class="text-sm font-medium text-gray-700">Hide this button</span>
                        </label>
                    </div>
                </div>
                
                <!-- Right Column: Preview -->
                <div>
                    <h4 class="text-sm font-medium text-gray-700 mb-2">Button Preview</h4>
                    <div id="buttonPreview" class="border-2 border-dashed border-gray-300 rounded-md p-4 text-center min-h-[100px] flex items-center justify-center">
                        <span class="text-gray-500">Button preview will appear here</span>
                    </div>
                    
                    <div class="mt-4">
                        <h4 class="text-sm font-medium text-gray-700 mb-2">Configuration Summary</h4>
                        <div id="configSummary" class="bg-gray-50 p-3 rounded-md text-sm">
                            <div><strong>Position:</strong> <span id="positionInfo">-</span></div>
                            <div><strong>Type:</strong> <span id="buttonTypeInfo">-</span></div>
                            <div><strong>Action:</strong> <span id="actionInfo">-</span></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 mt-6">
                <button id="clearButtonBtn" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600">Clear Button</button>
                <button id="cancelButtonEdit" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">Cancel</button>
                <button id="saveButtonEdit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save Button</button>
            </div>
        </div>
    </div>

    <!-- Help Wizard Modal -->
    <div id="helpWizardModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-2xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-900">Button Creation Wizard</h3>
                <button id="closeHelpWizard" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <!-- Wizard Steps -->
            <div id="wizardContent">
                <!-- Step 1: Button Name -->
                <div id="wizardStep1" class="wizard-step">
                    <h4 class="text-lg font-semibold mb-4">Step 1: What do you want to name the button?</h4>
                    <input type="text" id="wizardButtonName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Enter button name">
                    <p class="text-sm text-gray-600 mt-2">This is the text that will appear on the button.</p>
                </div>
                
                <!-- Step 2: Speech Phrase -->
                <div id="wizardStep2" class="wizard-step hidden">
                    <h4 class="text-lg font-semibold mb-4">Step 2: Do you want the button to say something before any action?</h4>
                    <input type="text" id="wizardSpeechPhrase" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Optional: What to say first">
                    <p class="text-sm text-gray-600 mt-2">This phrase will be spoken before the button performs its main action (optional).</p>
                </div>
                
                <!-- Step 3: Target Page -->
                <div id="wizardStep3" class="wizard-step hidden">
                    <h4 class="text-lg font-semibold mb-4">Step 3: Do you want to move to another page?</h4>
                    <select id="wizardTargetPage" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                        <option value="">No, stay on current page</option>
                    </select>
                    <p class="text-sm text-gray-600 mt-2">Select a page to navigate to when this button is pressed (optional).</p>
                </div>
                
                <!-- Step 4: AI Generation -->
                <div id="wizardStep4" class="wizard-step hidden">
                    <h4 class="text-lg font-semibold mb-4">Step 4: Do you want to use AI to generate options?</h4>
                    <textarea id="wizardAiDescription" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Describe what you want the AI to generate (optional)"></textarea>
                    <p class="text-sm text-gray-600 mt-2">Describe in general terms what you want the AI to help with. We'll create the technical prompt for you.</p>
                </div>
                
                <!-- Preview Step -->
                <div id="wizardPreview" class="wizard-step hidden">
                    <h4 class="text-lg font-semibold mb-4">Preview Your Button</h4>
                    <div id="wizardButtonPreview" class="border-2 border-dashed border-gray-300 rounded-md p-4 text-center min-h-[100px] flex items-center justify-center mb-4">
                        <span class="text-gray-500">Button preview</span>
                    </div>
                    <div id="wizardConfigPreview" class="bg-gray-50 p-3 rounded-md text-sm">
                        <!-- Configuration will be shown here -->
                    </div>
                </div>
            </div>
            
            <div class="flex justify-between mt-6">
                <button id="wizardPrevBtn" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 hidden">Previous</button>
                <div class="flex space-x-3">
                    <button id="wizardCancelBtn" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">Cancel</button>
                    <button id="wizardRejectBtn" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 hidden">Reject</button>
                    <button id="wizardNextBtn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Next</button>
                    <button id="wizardAcceptBtn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 hidden">Accept</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Picker Modal -->
    <div id="imagePickerModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-10 mx-auto p-5 border w-11/12 max-w-6xl shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-900">Select Button Image</h3>
                <button id="closeImagePicker" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <!-- Search Bar -->
            <div class="mb-4">
                <div class="flex space-x-3">
                    <input type="text" id="imageSearchInput" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Search images by keyword...">
                    <button id="imageSearchBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <i class="fas fa-search mr-2"></i>Search
                    </button>
                    <button id="clearImageSearch" class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500">
                        <i class="fas fa-times mr-2"></i>Clear
                    </button>
                </div>
            </div>
            
            <!-- Loading Indicator -->
            <div id="imageLoadingIndicator" class="text-center py-8 hidden">
                <i class="fas fa-spinner fa-spin text-2xl text-blue-500"></i>
                <p class="text-gray-600 mt-2">Loading images...</p>
            </div>
            
            <!-- Image Grid -->
            <div id="imageGrid" class="grid grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-3 mb-4 max-h-96 overflow-y-auto">
                <!-- Images will be populated here -->
            </div>
            
            <!-- Pagination -->
            <div id="imagePagination" class="flex justify-between items-center">
                <div class="text-sm text-gray-600">
                    <span id="imageResultsInfo">No images loaded</span>
                </div>
                <div class="flex space-x-2">
                    <button id="imagePrevPage" class="px-3 py-1 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span id="imagePageInfo" class="px-3 py-1 text-sm text-gray-600">Page 0 of 0</span>
                    <button id="imageNextPage" class="px-3 py-1 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- Modal Actions -->
            <div class="flex justify-end space-x-3 mt-4">
                <button id="cancelImageSelection" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">Cancel</button>
                <button id="selectImageBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    <i class="fas fa-check mr-2"></i>Select Image
                </button>
            </div>
        </div>
    </div>

    <!-- Migration Modal -->
    <div id="migrationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-2xl w-[95vw] h-[95vh] max-w-7xl flex flex-col">
            <!-- Modal Header -->
            <div class="flex justify-between items-center p-6 border-b">
                <h2 class="text-2xl font-bold text-gray-800">Migrate User Data</h2>
                <button id="closeMigrationModal" class="text-gray-500 hover:text-red-500 text-3xl font-bold">&times;</button>
            </div>
            
            <!-- Modal Content -->
            <div id="migrationContent" class="flex-1 overflow-y-auto p-6">
                <!-- Source Selection Screen -->
                <div id="sourceSelection" class="max-w-2xl mx-auto">
                    <h3 class="text-xl font-semibold mb-4">Select Migration Source</h3>
                    <p class="text-gray-600 mb-6">Choose where you want to import user data from:</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Accent Source -->
                        <button id="selectAccentSource" class="p-6 border-2 border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-left">
                            <div class="flex items-center gap-4 mb-3">
                                <div class="bg-purple-100 p-3 rounded-lg">
                                    <i class="fas fa-file-import text-purple-600 text-2xl"></i>
                                </div>
                                <h4 class="text-lg font-semibold">Accent Device</h4>
                            </div>
                            <p class="text-sm text-gray-600">Import pages and buttons from an Accent .mti file</p>
                        </button>
                        
                        <!-- Future Sources (Disabled) -->
                        <div class="p-6 border-2 border-gray-200 rounded-lg bg-gray-50 opacity-50 text-left">
                            <div class="flex items-center gap-4 mb-3">
                                <div class="bg-gray-200 p-3 rounded-lg">
                                    <i class="fas fa-ellipsis-h text-gray-400 text-2xl"></i>
                                </div>
                                <h4 class="text-lg font-semibold text-gray-400">Other Sources</h4>
                            </div>
                            <p class="text-sm text-gray-400">Coming soon...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Accent Migration Interface (Hidden by default) -->
                <div id="accentMigrationInterface" class="hidden">
                    <iframe id="accentMigrationFrame" src="/accent_migration.html" class="w-full h-full border-0" style="min-height: 70vh;"></iframe>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Migration Modal Logic
        const migrationModal = document.getElementById('migrationModal');
        const openMigrationBtn = document.getElementById('openMigrationBtn');
        const closeMigrationModal = document.getElementById('closeMigrationModal');
        const sourceSelection = document.getElementById('sourceSelection');
        const accentMigrationInterface = document.getElementById('accentMigrationInterface');
        const selectAccentSource = document.getElementById('selectAccentSource');
        
        openMigrationBtn.addEventListener('click', () => {
            migrationModal.classList.remove('hidden');
            // Reset to source selection
            sourceSelection.classList.remove('hidden');
            accentMigrationInterface.classList.add('hidden');
        });
        
        closeMigrationModal.addEventListener('click', () => {
            migrationModal.classList.add('hidden');
        });
        
        selectAccentSource.addEventListener('click', () => {
            sourceSelection.classList.add('hidden');
            accentMigrationInterface.classList.remove('hidden');
        });
        
        // Close on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !migrationModal.classList.contains('hidden')) {
                migrationModal.classList.add('hidden');
            }
        });
        
        // Close on backdrop click
        migrationModal.addEventListener('click', (e) => {
            if (e.target === migrationModal) {
                migrationModal.classList.add('hidden');
            }
        });
    </script>

    <script>
        // Guide resumption logic for cross-page guides
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Admin Pages loaded, checking for active guide...');
            
            // Initialize the guide system if not already present
            if (!window.pageGuide) {
                window.pageGuide = {
                    guideData: {
                        'customize-pages': {
                            title: 'Customize Pages and Buttons',
                            steps: [
                                {
                                    title: 'Unlock Admin Toolbar',
                                    icon: 'fa-unlock',
                                    content: `
                                        <p class="text-gray-700 mb-3">First, unlock the Admin toolbar to access Page Management.</p>
                                        <div class="bg-rose-50 border-l-4 border-rose-500 p-3 mb-3">
                                            <p class="text-sm"><i class="fas fa-info-circle text-rose-500 mr-2"></i>Click the <strong>lock icon</strong> in the top-left corner</p>
                                        </div>
                                        <p class="text-sm text-gray-600">When unlocked, it will show <i class="fas fa-unlock-alt text-green-500"></i></p>
                                    `
                                },
                                {
                                    title: 'Open Page Management',
                                    icon: 'fa-th',
                                    content: `
                                        <p class="text-gray-700 mb-3">Navigate to the Page Management interface.</p>
                                        <div class="bg-rose-50 border-l-4 border-rose-500 p-3 mb-3">
                                            <p class="text-sm"><i class="fas fa-info-circle text-rose-500 mr-2"></i>Click the <strong>grid icon</strong> <i class="fas fa-th text-rose-600"></i> in the Admin toolbar</p>
                                        </div>
                                        <p class="text-sm text-gray-600">This opens the page where you can customize pages and buttons.</p>
                                    `
                                },
                                {
                                    title: 'Select Content to Customize',
                                    icon: 'fa-mouse-pointer',
                                    content: `
                                        <p class="text-gray-700 mb-3">Choose which pages or buttons to edit.</p>
                                        <div class="bg-rose-50 border-l-4 border-rose-500 p-3 mb-3">
                                            <p class="text-sm"><i class="fas fa-info-circle text-rose-500 mr-2"></i>You can:</p>
                                            <ul class="text-xs text-gray-600 ml-4 mt-1 space-y-1">
                                                <li>‚Ä¢ Edit existing pages and buttons</li>
                                                <li>‚Ä¢ Change labels and images</li>
                                                <li>‚Ä¢ Reorganize button layout</li>
                                                <li>‚Ä¢ Import user data from other AAC devices</li>
                                            </ul>
                                        </div>
                                        <p class="text-sm text-gray-600">The Page Management interface lets you customize all aspects of your communication grid.</p>
                                    `
                                },
                                {
                                    title: 'Make Customizations',
                                    icon: 'fa-edit',
                                    content: `
                                        <p class="text-gray-700 mb-3">Customize labels, images, and content as needed.</p>
                                        <div class="bg-rose-50 border-l-4 border-rose-500 p-3 mb-3">
                                            <p class="text-sm"><i class="fas fa-info-circle text-rose-500 mr-2"></i>Edit the content to match the user's needs</p>
                                        </div>
                                        <div class="bg-blue-50 border-l-4 border-blue-500 p-3">
                                            <p class="text-xs text-gray-600"><i class="fas fa-question-circle text-blue-600 mr-2"></i>For more details on making changes, refer to the Help menu on the Page & Button Administration page</p>
                                        </div>
                                    `
                                }
                            ]
                        }
                    },
                    
                    start: function(taskId, stepIndex = 0) {
                        console.log('pageGuide.start called:', taskId, stepIndex);
                        const task = this.guideData[taskId];
                        if (!task) {
                            console.error('Task not found:', taskId);
                            return;
                        }
                        
                        this.currentTask = taskId;
                        this.currentStep = stepIndex;
                        
                        // Show or create the guide window
                        this.showGuideWindow(task);
                    },
                    
                    showGuideWindow: function(task) {
                        console.log('showGuideWindow called for task:', task.title);
                        let guideWindow = document.getElementById('page-setup-guide');
                        console.log('Existing guide window:', !!guideWindow);
                        
                        // Create guide window if it doesn't exist
                        if (!guideWindow) {
                            console.log('Creating new guide window...');
                            guideWindow = document.createElement('div');
                            guideWindow.id = 'page-setup-guide';
                            guideWindow.className = 'fixed top-20 right-4 w-96 bg-white rounded-lg shadow-2xl border-2 border-blue-500 z-50';
                            guideWindow.innerHTML = `
                                <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-4 rounded-t-lg">
                                    <div class="flex items-center justify-between">
                                        <h3 id="page-guide-title" class="text-lg font-bold"></h3>
                                        <button id="page-guide-close" class="text-white hover:text-gray-200">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                    <div id="page-guide-progress" class="text-sm opacity-90 mt-1"></div>
                                </div>
                                <div class="p-6">
                                    <div id="page-guide-step-indicator" class="flex gap-2 mb-4"></div>
                                    <div id="page-guide-content" class="mb-6"></div>
                                    <div class="flex gap-3">
                                        <button id="page-guide-prev" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
                                            <i class="fas fa-arrow-left mr-1"></i> Previous
                                        </button>
                                        <button id="page-guide-next" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
                                            Next <i class="fas fa-arrow-right ml-1"></i>
                                        </button>
                                    </div>
                                </div>
                            `;
                            document.body.appendChild(guideWindow);
                            console.log('Guide window created and appended');
                            
                            // Add event listeners with proper binding
                            const self = this;
                            setTimeout(() => {
                                const closeBtn = document.getElementById('page-guide-close');
                                const prevBtn = document.getElementById('page-guide-prev');
                                const nextBtn = document.getElementById('page-guide-next');
                                
                                console.log('Attaching event listeners - closeBtn:', !!closeBtn, 'prevBtn:', !!prevBtn, 'nextBtn:', !!nextBtn);
                                
                                if (closeBtn) closeBtn.addEventListener('click', () => self.close());
                                if (prevBtn) prevBtn.addEventListener('click', () => self.previousStep());
                                if (nextBtn) nextBtn.addEventListener('click', () => self.nextStep());
                                
                                console.log('Event listeners attached');
                            }, 100);
                        }
                        
                        // Update the guide window
                        guideWindow.classList.remove('hidden');
                        guideWindow.style.display = 'block';
                        
                        // Wait for DOM to be ready, then update content
                        setTimeout(() => {
                            const titleEl = document.getElementById('page-guide-title');
                            if (titleEl) {
                                titleEl.textContent = task.title;
                                console.log('Title set to:', task.title);
                            }
                            this.showStep();
                        }, 150);
                    },
                    
                    showStep: function() {
                        console.log('showStep called - currentTask:', this.currentTask, 'currentStep:', this.currentStep);
                        const task = this.guideData[this.currentTask];
                        const step = task.steps[this.currentStep];
                        console.log('Step data:', step);
                        
                        // Update progress
                        const progressEl = document.getElementById('page-guide-progress');
                        console.log('Progress element:', !!progressEl);
                        if (progressEl) {
                            progressEl.textContent = `Step ${this.currentStep + 1} of ${task.steps.length}`;
                        }
                        
                        // Update content
                        const contentEl = document.getElementById('page-guide-content');
                        console.log('Content element:', !!contentEl);
                        if (contentEl) {
                            contentEl.innerHTML = `
                                <div class="flex items-center gap-3 mb-4">
                                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-rose-500 to-pink-500 flex items-center justify-center text-white">
                                        <i class="fas ${step.icon} text-xl"></i>
                                    </div>
                                    <h4 class="text-lg font-semibold text-gray-800">${step.title}</h4>
                                </div>
                                ${step.content}
                            `;
                            console.log('Content updated');
                        }
                        
                        // Update step indicators
                        const container = document.getElementById('page-guide-step-indicator');
                        console.log('Step indicator container:', !!container);
                        if (container) {
                            container.innerHTML = '';
                            for (let i = 0; i < task.steps.length; i++) {
                                const dot = document.createElement('div');
                                dot.className = 'w-3 h-3 rounded-full ' + 
                                    (i === this.currentStep ? 'bg-blue-500' : 
                                     i < this.currentStep ? 'bg-green-500' : 'bg-gray-300');
                                container.appendChild(dot);
                            }
                        }
                        
                        // Update buttons
                        const prevBtn = document.getElementById('page-guide-prev');
                        if (prevBtn) {
                            prevBtn.style.display = this.currentStep === 0 ? 'none' : 'block';
                        }
                        
                        const nextBtn = document.getElementById('page-guide-next');
                        if (nextBtn) {
                            if (this.currentStep === task.steps.length - 1) {
                                nextBtn.innerHTML = '<i class="fas fa-check mr-1"></i> Complete';
                            } else {
                                nextBtn.innerHTML = 'Next <i class="fas fa-arrow-right ml-1"></i>';
                            }
                        }
                        
                        console.log('showStep completed');
                        
                        // Save state
                        localStorage.setItem('activeGuide', JSON.stringify({
                            taskId: this.currentTask,
                            stepIndex: this.currentStep
                        }));
                    },
                    
                    nextStep: function() {
                        const task = this.guideData[this.currentTask];
                        if (this.currentStep < task.steps.length - 1) {
                            this.currentStep++;
                            this.showStep();
                        } else {
                            this.complete();
                        }
                    },
                    
                    previousStep: function() {
                        if (this.currentStep > 0) {
                            this.currentStep--;
                            this.showStep();
                        }
                    },
                    
                    complete: function() {
                        document.getElementById('guide-content').innerHTML = `
                            <div class="text-center py-8">
                                <div class="w-16 h-16 rounded-full bg-green-500 flex items-center justify-center text-white mx-auto mb-4">
                                    <i class="fas fa-check text-3xl"></i>
                                </div>
                                <h4 class="text-xl font-semibold text-gray-800 mb-2">Task Complete!</h4>
                                <p class="text-gray-600">You've completed customizing pages and buttons.</p>
                            </div>
                        `;
                        
                        localStorage.removeItem('activeGuide');
                        
                        setTimeout(() => {
                            this.close();
                        }, 2000);
                    },
                    
                    close: function() {
                        const guideWindow = document.getElementById('page-setup-guide');
                        if (guideWindow) {
                            guideWindow.style.display = 'none';
                        }
                        localStorage.removeItem('activeGuide');
                    }
                };
            }
            
            // Small delay to ensure guide systems are initialized
            setTimeout(() => {
                const savedGuide = localStorage.getItem('activeGuide');
                console.log('Saved guide state:', savedGuide);
                
                if (savedGuide) {
                    try {
                        const guideState = JSON.parse(savedGuide);
                        console.log('Found active guide to resume:', guideState);
                        
                        // Check if this is the customize-pages guide
                        if (guideState.taskId === 'customize-pages') {
                            console.log('Resuming customize-pages guide on admin_pages');
                            window.pageGuide.start(guideState.taskId, guideState.stepIndex || 0);
                        }
                    } catch (e) {
                        console.error('Error parsing saved guide:', e);
                    }
                }
            }, 500);
        });
    </script>

</body>
</html>

