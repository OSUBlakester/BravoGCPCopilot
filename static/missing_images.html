<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Missing Images Log - Bravo Admin</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f7;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 600;
        }
        
        .header p {
            margin: 10px 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .controls {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .filter-group label {
            font-weight: 500;
            color: #495057;
        }
        
        select, button {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
        }
        
        button {
            background: #007bff;
            color: white;
            cursor: pointer;
            border: none;
            font-weight: 500;
            transition: background 0.2s;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        .export-btn {
            background: #28a745;
        }
        
        .export-btn:hover {
            background: #1e7e34;
        }
        
        .stats {
            padding: 20px 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            background: #f8f9fa;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 0.9em;
        }
        
        .table-container {
            padding: 30px;
        }
        
        .images-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .images-table th,
        .images-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        
        .images-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
        }
        
        .images-table tr:hover {
            background: #f8f9fa;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 500;
        }
        
        .status-missing {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-in_progress {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-resolved {
            background: #d4edda;
            color: #155724;
        }
        
        .priority-high {
            color: #dc3545;
            font-weight: bold;
        }
        
        .priority-medium {
            color: #fd7e14;
        }
        
        .priority-low {
            color: #6c757d;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            margin: 20px;
        }
        
        .search-count {
            font-weight: bold;
            color: #007bff;
        }
        
        .quick-actions {
            display: flex;
            gap: 5px;
        }
        
        .quick-actions button {
            padding: 4px 8px;
            font-size: 0.8em;
            min-width: auto;
        }
        
        .btn-update {
            background: #17a2b8;
        }
        
        .btn-update:hover {
            background: #117a8b;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üñºÔ∏è Missing Images Log</h1>
            <p>Track and manage button images that need to be created</p>
        </div>
        
        <div class="controls">
            <div class="filter-group">
                <label for="statusFilter">Status:</label>
                <select id="statusFilter">
                    <option value="all">All</option>
                    <option value="missing" selected>Missing</option>
                    <option value="in_progress">In Progress</option>
                    <option value="resolved">Resolved</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="priorityFilter">Priority:</label>
                <select id="priorityFilter">
                    <option value="all" selected>All</option>
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                </select>
            </div>
            
            <button onclick="loadMissingImages()">üîÑ Refresh</button>
            <button class="export-btn" onclick="exportData('json')">üìÑ Export JSON</button>
            <button class="export-btn" onclick="exportData('csv')">üìä Export CSV</button>
        </div>
        
        <div class="stats" id="stats">
            <!-- Stats will be loaded here -->
        </div>
        
        <div class="table-container">
            <div id="loading" class="loading">Loading missing images...</div>
            <div id="error" class="error" style="display: none;"></div>
            
            <table class="images-table" id="imagesTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Search Term</th>
                        <th>Requests</th>
                        <th>Status</th>
                        <th>Priority</th>
                        <th>First Seen</th>
                        <th>Last Seen</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="imagesTableBody">
                    <!-- Table rows will be populated here -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let currentData = [];
        
        async function loadMissingImages() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const table = document.getElementById('imagesTable');
            
            loading.style.display = 'block';
            error.style.display = 'none';
            table.style.display = 'none';
            
            try {
                const status = document.getElementById('statusFilter').value;
                const priority = document.getElementById('priorityFilter').value;
                
                const response = await window.authenticatedFetch(`/api/missing-images?status=${status}&priority=${priority}&limit=500`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                currentData = data.missing_images;
                
                displayMissingImages(data.missing_images);
                updateStats(data.missing_images);
                
            } catch (err) {
                console.error('Error loading missing images:', err);
                error.textContent = `Error loading data: ${err.message}`;
                error.style.display = 'block';
            } finally {
                loading.style.display = 'none';
            }
        }
        
        function displayMissingImages(images) {
            const tableBody = document.getElementById('imagesTableBody');
            const table = document.getElementById('imagesTable');
            
            if (images.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #6c757d;">No missing images found</td></tr>';
            } else {
                tableBody.innerHTML = images.map(image => `
                    <tr>
                        <td><strong>${escapeHtml(image.search_term)}</strong></td>
                        <td><span class="search-count">${image.search_count}</span></td>
                        <td><span class="status-badge status-${image.status}">${image.status.replace('_', ' ')}</span></td>
                        <td><span class="priority-${image.priority}">${image.priority}</span></td>
                        <td>${formatDate(image.first_searched)}</td>
                        <td>${formatDate(image.last_searched)}</td>
                        <td>
                            <div class="quick-actions">
                                <button class="btn-update" onclick="updateImageStatus('${image.id}', 'in_progress')">Start</button>
                                <button class="btn-update" onclick="updateImageStatus('${image.id}', 'resolved')">Done</button>
                                <button onclick="updateImagePriority('${image.id}', 'high')">üî¥</button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }
            
            table.style.display = 'table';
        }
        
        function updateStats(images) {
            const stats = document.getElementById('stats');
            
            const totalCount = images.length;
            const totalRequests = images.reduce((sum, img) => sum + img.search_count, 0);
            const highPriority = images.filter(img => img.priority === 'high').length;
            const inProgress = images.filter(img => img.status === 'in_progress').length;
            
            stats.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${totalCount}</div>
                    <div class="stat-label">Missing Images</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${totalRequests}</div>
                    <div class="stat-label">Total Requests</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${highPriority}</div>
                    <div class="stat-label">High Priority</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${inProgress}</div>
                    <div class="stat-label">In Progress</div>
                </div>
            `;
        }
        
        async function updateImageStatus(imageId, newStatus) {
            try {
                const response = await window.authenticatedFetch(`/api/missing-images/${imageId}/update`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus })
                });
                
                if (response.ok) {
                    loadMissingImages(); // Refresh the table
                } else {
                    alert('Failed to update status');
                }
            } catch (err) {
                console.error('Error updating status:', err);
                alert('Error updating status');
            }
        }
        
        async function updateImagePriority(imageId, newPriority) {
            try {
                const response = await window.authenticatedFetch(`/api/missing-images/${imageId}/update`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ priority: newPriority })
                });
                
                if (response.ok) {
                    loadMissingImages(); // Refresh the table
                } else {
                    alert('Failed to update priority');
                }
            } catch (err) {
                console.error('Error updating priority:', err);
                alert('Error updating priority');
            }
        }
        
        async function exportData(format) {
            try {
                const status = document.getElementById('statusFilter').value;
                const response = await window.authenticatedFetch(`/api/missing-images/export?format=${format}&status=${status}`);
                
                if (format === 'csv') {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `missing_images_${status}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    const data = await response.json();
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `missing_images_${status}.json`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                }
            } catch (err) {
                console.error('Error exporting data:', err);
                alert('Export failed');
            }
        }
        
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Add filter change listeners
        document.getElementById('statusFilter').addEventListener('change', loadMissingImages);
        document.getElementById('priorityFilter').addEventListener('change', loadMissingImages);
    </script>
    
    <!-- Firebase authentication setup -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    
    <script>
        // Firebase initialization and authentication setup
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // 1. Load Firebase config from server
                const configResponse = await fetch('/api/frontend-config');
                if (!configResponse.ok) {
                    throw new Error(`Failed to load Firebase config: ${configResponse.status}`);
                }
                const configData = await configResponse.json();
                const firebaseConfig = configData.firebase_config || configData;
                if (!firebaseConfig || !firebaseConfig.apiKey) {
                    throw new Error('Invalid config from server.');
                }
                console.log('Firebase config loaded successfully');

                // 2. Initialize Firebase
                firebase.initializeApp(firebaseConfig);
                const auth = firebase.auth();
                console.log(`Firebase initialized for project: ${firebaseConfig.projectId}`);

                // 3. Check for logged-in user and set up context
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        const currentAacUserId = sessionStorage.getItem("currentAacUserId");
                        const tokenFromUser = await user.getIdToken();
                        sessionStorage.setItem("firebaseIdToken", tokenFromUser);

                        if (!currentAacUserId) {
                            console.warn("No AAC User ID found in session. Redirecting to auth page for user selection.");
                            window.location.href = 'auth.html';
                            return;
                        }

                        // Define authenticatedFetch function
                        window.authenticatedFetch = async (url, options = {}) => {
                            const headers = options.headers || {};
                            headers['Authorization'] = `Bearer ${tokenFromUser}`;
                            headers['X-User-ID'] = currentAacUserId;
                            
                            // Handle admin context if present
                            const adminTargetAccountId = sessionStorage.getItem('adminTargetAccountId');
                            if (adminTargetAccountId) {
                                headers['X-Admin-Target-Account'] = adminTargetAccountId;
                            }
                            
                            options.headers = headers;
                            
                            try {
                                const response = await fetch(url, options);
                                if (response.status === 401 || response.status === 403) {
                                    console.warn(`Auth failed (${response.status}). Redirecting to login.`);
                                    sessionStorage.clear();
                                    window.location.href = 'auth.html';
                                    throw new Error("Session expired.");
                                }
                                return response;
                            } catch (error) {
                                console.error('Fetch error:', error);
                                throw error;
                            }
                        };

                        // Set global context
                        window.currentAacUserId = currentAacUserId;
                        window.firebaseIdToken = tokenFromUser;
                        
                        // Initialize the missing images page
                        loadMissingImages();
                        
                    } else {
                        console.log('No user logged in, redirecting to auth page');
                        window.location.href = 'auth.html';
                    }
                });

            } catch (error) {
                console.error('Error initializing Firebase:', error);
                document.getElementById('error').textContent = 'Failed to initialize authentication';
                document.getElementById('error').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
            }
        });
    </script>
</body>
</html>